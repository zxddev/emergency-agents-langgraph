# 侦察任务现状

## 当前整体流程

- **输入口**：Java 服务暴露 `/web-api/api/v1/ai/reconnaissance/solution`，内部通过 `AiProxyServiceImpl.generateReconPlan` 代理调用 Python LangGraph `/recon/plans`。
- **指令解析**：LangGraph 侦察流程先用 `_parse_intent` 从自然语言抽取风险关键词与坐标，再查询 Postgres 事件、装备、队伍、占用任务等数据。
- **规划生成**：`ReconPipeline` 调用 `OpenAIReconLLMEngine` 生成蓝图，转换成 `ReconPlan` 与 `ReconPlanDraft`，草稿内含方案概要、任务 payload、设备推荐。
- **结果返回**：Python 返回 `plan`、`plan_summary`、`tasks`，Java 将其封装为 `ReconPlanResponse` 并透出给前端，同时记录 `python_outbound/python_inbound` 日志便于排障。

## 数据依赖与前置条件

- **事件编号**：必须使用 Postgres `operational.events` 中存在的 `event_id`，否则 `fetch_hazard_snapshot` 会抛 `LookupError` 导致 500。
- **设备筛选**：`operational.device` 需存在 `is_recon=true` 的装备，且关联 `car_device_select`、`car_supply_select` 选中记录；若无，流程会提示“无可用侦察装备”。
- **占用排除**：`operational.tasks` 中 `type=uav_recon` 的任务会被视为占用设备，网关会过滤，保证未被调度的资源才参与规划。
- **能力映射**：`operational.device_capability` 存储装备能力标签；缺少时会退回默认映射，但仍要求至少具备 `aerial_recon`、`hazmat_detection` 等关键能力，以便匹配任务需求。

## 性能与超时设置

- **生成时长**：以事件 `1d7d9681-6c3b-4b80-a9d0-4e08046aca88` 为例，直接调用 LangGraph 约 43 秒完成，Java 端全流程约 47 秒。
- **超时配置**：`python.service.read-timeout` 默认已提升至 300 秒（属性类与 `application.properties` 一致），防止 LangGraph 长流程触发 `HttpTimeoutException`。
- **监控日志**：`RestClientConfig` 拦截器在 info 级打印 `python_outbound`/`python_inbound`（包含请求体大小、响应状态），Debug 模式附带完整 body，便于核对数据。

## 已知风险与后续建议

- 若数据库缺少侦察设备或能力配置，规划会直接失败，需要补齐 `is_recon` 标记与能力表数据。
- 长流程仍受 LLM 推理速度影响，若后续场景耗时进一步增加，应考虑排队/异步方案或继续调大超时并评估系统资源。
- 前端接入时需保证事件 ID 来源可靠，并在 UI 提示生成过程可能耗时 40–60 秒。

