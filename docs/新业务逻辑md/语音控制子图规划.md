# 语音控制多终端子图规划

## 现状核查

- **救援主图引用点**：`src/emergency_agents/graph/app.py:240` 起构建 `StateGraph(RescueState)`，当前语音指令经过 `intent_router_node` 直接落到 `robotdog_control_node`，流程与救援态势共用状态，耦合严重。
- **路由与确认逻辑**：`src/emergency_agents/intent/router.py:60-196` 里根据 `intent_type` 进行分支；机器狗控制在路由层触发 `interrupt()` 读回确认，并在同一状态树写入 `robotdog_command`。
- **设备适配器**：`src/emergency_agents/external/adapter_client.py:1-118` 暴露 `AdapterHubClient` 与 `build_robotdog_move_command`，目前只覆盖鼎桥机器狗动作映射。

结论：现有实现仅覆盖机器狗控制，且嵌入救援主图；无独立子图或统一命令规范，后续扩展无人机/机器人/无人船艇会放大耦合成本。

## 目标

1. 按 LangGraph 最佳实践构建独立 `StateGraph(VoiceControlState)`，与救援、侦察子图解耦。
2. 支持基础动作控制：无人机(UAV)、机器狗(Dog)、陆地机器人(Robot)、无人船艇(USV)。
3. 建立统一命令模型与设备适配层，便于扩展与审计。
4. 保留现有救援子图逻辑，后续通过路由迁移流量，不直接修改既有节点。

## 子图设计

### 状态结构

```python
class VoiceControlState(TypedDict, total=False):
    request_id: str
    raw_text: str
    normalized_intent: ControlIntent
    device_command: DeviceCommand
    adapter_result: AdapterDispatchResult
    status: Literal["init", "validated", "dispatched", "error"]
    error_detail: str
    audit_trail: list[dict[str, Any]]
```

- `ControlIntent`：封装设备类型、动作、参数、复诵文案。
- `DeviceCommand`：统一字段 `device_type`/`device_id`/`action`/`params`，所有节点共享。
- `audit_trail`：记录中断确认、下发状态，满足“多加日志”要求。

### 节点划分

| 节点 | 作用 | 关键操作 |
| --- | --- | --- |
| `ingest_intent` | 接收语音/文本指令，写入 `raw_text`，生成 `request_id` | 记录初始日志 `voice_control_ingest` |
| `normalize_intent` | 调用 LLM/规则解析设备类型与动作 | 若缺槽位则写入 `status=error` 与 `error_detail` |
| `confirm_action` | 使用 `interrupt()` 完成人工复诵确认，遵循 `concept-human-in-the-loop.md` | 将确认结果追加到 `audit_trail` |
| `build_command` | 基于 `normalized_intent` 构造 `DeviceCommand`，映射到设备 schema | 复用/扩展 `adapter_client` 中规范化函数 |
| `dispatch_command` | 通过 `AdapterHubClient` 发送指令，捕获响应与异常 | 追加日志 `adapter_dispatch`、处理超时 |
| `finalize` | 汇聚状态并返回给调用方 | 写入 `status`、`adapter_result` |

所有节点均以 `StateGraph` 注册，入口节点 `ingest_intent`，终点 `finalize`。

### Checkpoint 与配置

- 复用 `SqliteSaver`/`PostgresSaver` 模式（参考 `app.py:306-332`），保持可恢复性。
- 在 FastAPI 启动时与侦察子图类似初始化：
  - 创建 `AdapterHubClient`（按设备类型持有多实例）。
  - 构造 `VoiceControlPipeline`（用于解析槽位）。
  - `build_voice_control_graph(pipeline, adapters)` → `app.state.voice_control_graph`。

## 设备适配层

### 命令协议

- 定义 `DeviceType` 枚举：`uav`, `robotdog`, `ugv`, `usv`。
- 针对每类设备提供规范化函数：
  - UAV：航向、速度、海拔（新增 `build_uav_command`）。
  - RobotDog：沿用 `build_robotdog_move_command`。
  - UGV/USV：对接 Java `Adapter Hub` 现有实体模型，需确认字段（后续与 Java 侧联调）。

### 实现要点

- 新增 `src/emergency_agents/external/control_commands.py`（计划）：集中存放命令构造与合法性校验。
- 统一日志：每次构造命令向 `audit_trail` 推送 `{"event": "command_built", "device_type": ...}`。
- Adapter 超时捕获：当 `AdapterHubClient` 抛 `AdapterHubRequestError` 时，将 `status` 置为 `error`，方便外部重试。

## 流程对接

1. **语音入口**：`src/emergency_agents/api/voice_chat.py`（WebSocket）在解析完用户文本后，将 `intent_type in {device_control_*}` 的请求改为调用 `voice_control_graph.invoke()`。
2. **REST 入口**：新增 `POST /control/commands`（FastAPI），用于前端或定制脚本直接发送文本命令，便于联调。
3. **结果返回**：统一返回 `request_id`、确认提示、适配器响应，供 Java 侧通过 WebSocket 推送。

## 日志与监控

- 统一使用 `structlog`，关键位置记录：`voice_control_ingest`、`voice_control_confirm`、`voice_control_dispatch`、`voice_control_error`。
- 在 `dispatch_command` 节点将 Adapter 响应写入 `audit_trail`，同时输出 info 级日志，满足“多加日志”要求。

## 验证计划

1. **单元测试**：
   - `tests/control/test_commands.py`：覆盖命令规范化与非法参数。
   - `tests/control/test_voice_control_graph.py`：使用 dummy adapter 验证节点跳转、HITL 流程。
2. **集成测试**：通过 Mock AdapterHub 服务验证完整 `invoke` → `interrupt` → `resume` 流程。
3. **文档同步**：后续实现完成后更新本文件“落地状态”小节，记录实际模块路径。

## 后续迁移

- 阶段 1：语音通道（WebSocket / REST）直接调用新子图，同时保留救援图中的机器人狗节点，但在 `intent_router` 中优先路由到语音子图。
- 阶段 2：待语音子图稳定后，移除救援主图的 `robotdog_control` 分支，届时需重新评估救援状态字段。

## 落地状态（2025-01-13）

- **模型与流水线**：`src/emergency_agents/control/` 目录新增 `models.py`、`pipeline.py`，提供 `VoiceControlPipeline`、`ControlIntent`、`DeviceCommand` 等强类型结构。
- **子图实现**：`src/emergency_agents/graph/voice_control_app.py` 实现 `build_voice_control_graph`，节点覆盖 `ingest → normalize → confirm → build_command → dispatch → finalize`，审计行为落入 `audit_trail`。
- **API 接入**：`src/emergency_agents/api/voice_control.py` 暴露 `POST /voice/control/commands`；`api/main.py` 在启动阶段装载子图并注入 `app.state.voice_control_graph`。
- **Adapter 复用**：复用了 `external/adapter_client.py` 里 `build_robotdog_move_command`，REST 下发命中适配器 `POST /api/v3/device-access/control`。
- **验证**：新增 `tests/control/test_pipeline.py`、`tests/control/test_voice_control_graph.py`，覆盖指令解析、错误场景及（依赖存在时）子图调度。缺失 LangGraph 依赖时自动跳过子图测试。
