# 子图体系开发规划（战术/战略一体化）

## 1. 规划目的与范围
- 聚焦 `/home/msq/gitCode/new_1/emergency-agents-langgraph` 内部 LangGraph 子图拆分，覆盖战术救援、战术侦察、语音设备控制及战略层智能体。
- 输出开发顺序、必备基座、各子图输入输出与关键节点，指导并行开发与代码落地。
- 仅引用当前有效文档：`救援方案全链路展示.md`、`战术救援子图拆分.md`、`风险预测与路线避险设计.md`，其余历史文档不再参考。

## 2. 共性基座（Phase 0 必达）
| 模块 | 说明 | 参考/位置 |
| --- | --- | --- |
| 数据模型与 DAO | 统一 `Incident`、`Task`、`Entity`、`Snapshot`、`RiskZone` 强类型模型及异步 DAO，避免各子图自定义结构。 | `src/emergency_agents/db/*`（待新增补齐） |
| UI Action 协议 | 约定 `ui_actions` JSON schema（如 `fly_to`、`open_plan_panel`、`show_risk_warning`、`device_control_ack`），统一由 `src/emergency_agents/ui/actions.py` 构建与序列化，前端统一消费。 | FastAPI 输出层 |
| LLM 客户端工厂 | 通过 `LLMClientFactory` 为不同子图/节点选择独立模型 Key 或本地模型实例，无需全局限流；支持厂商/本地并存。 | `src/emergency_agents/llm/factory.py`（待新增） |
| 日志与指标 | 统一使用 structlog，新增 `*_start`/`*_completed`/`*_failed` 日志，Prometheus 监控 `*_duration_seconds`、`*_count`。 | `src/emergency_agents/logging.py` |
| 模拟器与事件通道 | 复用仿真（SIM）子系统、Adapter Hub、STOMP/WebSocket 通道，避免重复造轮子。 | `docs/应急AI人机协作方案/指挥车人机协作体系设计.md` |

> Phase 0 未完成前禁止拆分分支，确保后续子图共用底座。

> 当前阶段聚焦 AI 项目本身，前端改造全部后置；所有返回保持结构化，待 AI 链路稳定后再交付前端团队。

## 3. 战术层子图

### 3.1 战术救援子图（RescueTacticalGraph）
- **入口意图：** `RESCUE_TASK_GENERATION`（语音/文字），来源：自动发现、手动标注、语音标注。
- **核心输入 Slots：** `coordinates.lat/lng`、`mission_type`、`situation_summary`（≥15 字）、`event_type`。
- **关键节点：**
  1. `resolve_location` → 高德逆地理；
  2. `kg_requirement_lookup` → `KGService`；
  3. `rag_case_retrieval` → `RagPipeline`；
  4. `resource_matcher` → 推荐队伍/装备；
  5. `route_planning` → 高德路径 + 风险避险（依赖风险子图缓存）。
- **输出结构：** `rescue_task`（plan.overview/lines/resources/risks/evidence_trace）、`routes`、`recommendations`、`ui_actions`（`fly_to`、`open_plan_panel` 等）。
- **外部依赖：** Orchestrator（广播）、Amap、KG、RAG、PostgreSQL。
- **必备日志：** `rescue_task_completed`、`rescue_ui_actions_emitted`、`route_risk_detected`。
- **待办：** 实体落库接口、本地链路 UI 动作、任务确认 REST、风险提醒落地。

### 3.2 战术侦察子图（ScoutTacticalGraph）
- **入口意图：** `SCOUT_TASK_GENERATION`（语音/文字/自动触发）。
- **核心输入 Slots：** `coordinates`、`target_type`（坍塌、危化等）、`recon_objective`、`priority`。
- **关键节点：**
  1. `device_selection` → 筛选可用无人机/机器人（结合设备状态表、能力标签）；
  2. `recon_route_planning` → 基于目标周边生成巡航 Waypoints（沿道路/河道/楼层）；
  3. `sensor_payload_assignment` → 为设备分配相机/红外/气体检测任务；
  4. `intel_requirement_builder` → 汇总需要采集的情报项；
  5. `risk_overlay` → 引用风险区域，标注危险点位与规避动作。
- **输出结构：** `scout_plan`（targets、devices、waypoints、intel_requirements、risk_warnings）、`ui_actions`（`fly_to`、`open_scout_panel`、`preview_route`）、`ws_payload`（供模拟器/设备通道）。
- **外部依赖：** 设备资产表（Adapter Hub）、高德/地形数据、风险缓存、RAG（案例库：侦察流程）。
- **日志指标：** `scout_plan_ready`、`scout_device_allocated`、`scout_route_generated`。
- **现状：** 已上线 `graph/scout_tactical_app.py` 基础骨架（基于风险区域生成侦察目标、情报需求、传感器建议），`scout_task_generation.py` 输出 `scout_plan` 面板并推送 `show_risk_warning`。设备分配与航线规划仍待补充。
- **待办：** 定义 `ScoutTask` 模型、实现设备状态同步、前端侦察面板。

## 4. 控制层子图

### 4.1 语音设备控制处理器（VoiceControlHandler）
- **入口意图：** `DEVICE_CONTROL_VOICE`（走意图路由但无需构建 LangGraph 子图）。
- **输入 Slots：** `device_id`、`action`（起飞/返航/切流/载荷切换等）、`parameters`（高度、航向）。
- **处理流程：**
  1. 解析 Slot，校验设备在线与权限；
  2. 通过 Adapter Hub/控制通道下发指令；
  3. 同步等待 Ack 并返回强类型 `control_events`；
  4. 失败直接抛错，禁止兜底。
- **输出：** `control_events`（ack/错误）、`ui_actions`（`show_toast`、`update_device_status`）。
- **日志：** `device_control_issued`、`device_control_ack`、`device_control_timeout`。
- **说明：** 以强类型 Handler/Agent 实现即可，无需 LangGraph 模型；保持与战术子图解耦。

## 5. 战略层子图

### 5.1 战略侦察规划（StrategicReconGraph）
- **触发方式：** 指挥席 REST 调用或调度任务（非语音）。
- **输入：** 当前 Incident 快照、战术侦察结果、地理/气象数据。
- **输出：** `strategic_recon_plan`（分阶段侦察目标、优先等级、资源分配建议），支持审批流程。
- **依赖：** Snapshot DAO、RAG（历史行动）、KG（侦察 doctrine）、风险区域。
- **日志：** `strategic_recon_generated`、`strategic_recon_submitted`。

### 5.2 战略救援规划（StrategicRescueGraph）
- **触发方式：** REST/调度。
- **输入：** 当前救援任务进度、资源占用、风险预测。
- **输出：** `strategic_rescue_plan`（宏观分线、资源调度、阶段目标），可生成下发建议。
- **日志：** `strategic_rescue_generated`、`strategic_rescue_conflict_detected`。

### 5.3 态势上报（SITREPGraph）
- **触发方式：** 定时任务（例如每 30 分钟）或手动调用。
- **输入：** 最新快照、事件列表、执行进度、风险提示。
- **输出：** `sitrep_report`（结构化字段 + LLM 生成摘要），同步省级指挥大厅。
- **日志：** `sitrep_compiled`、`sitrep_delivery_success`、`sitrep_delivery_failed`。

### 5.4 行动评估（PostActionAssessmentGraph）
- **触发：** 阶段结束后手动请求。
- **输入：** 任务完成情况、受援人员统计、设备损耗。
- **输出：** 评估报告（支持当前 `reports.py` 灾情评估接口扩展）。
- **日志：** `post_action_assessment_ready`。

## 6. 风险与安全子图

### 6.1 风险预测子图（RiskPredictionGraph）
- **触发：** 定时（5 分钟）/事件驱动。
- **流程：** 多源数据采集 → 风险评分 → 写入 `risk_zones` → 通知缓存刷新。
- **日志：** `risk_assessment_start`、`risk_zone_update`、`risk_assessment_completed`。

### 6.2 路线风险提醒子图（RouteRiskGuard）
- **触发：** 路径规划节点调用或队伍位置更新触发。
- **功能：** 对比队伍路线与 `risk_zones`，生成 `route_warnings`，推送 UI 提醒。
- **日志：** `route_risk_detected`、`route_risk_cleared`。

### 6.3 指挥车/队伍位置监控子图（TeamMonitorGraph）
- **触发：** WebSocket/消息队列监听实时位置。
- **功能：** 判断队伍与风险区域/任务点距离，提前预警（例如 30 分钟前风险）。
- **输出：** `ui_actions`（`show_risk_warning`、`highlight_route_segment`）、`monitor_events`。
- **日志：** `team_position_ingested`、`risk_proximity_alert`。

## 7. 群众安置与补给子图

### 7.1 安置点推荐子图（ShelterRecommendationGraph）
- **输入：** 风险区域、可用避难所（容量/设施）、交通状态。
- **输出：** `shelter_plan`（推荐避难点、容量分配、路线说明）。
- **日志：** `shelter_plan_ready`。

### 7.2 补给任务规划子图（SupplyMissionGraph）
- **输入：** 物资库存、需求清单、风险路径。
- **输出：** `supply_missions`（车辆/路线/时间窗/风险提示）。
- **日志：** `supply_mission_generated`、`supply_route_risk`.

> 两者与战略层互动，优先在后续 Phase 实现。

## 8. 分阶段里程碑与并行策略

| 阶段 | 目标 | 主要交付 | 分支策略 |
| --- | --- | --- | --- |
| **Phase 0** | 共性基座 | 模型/DAO、UI Action 协议、限流组件、日志指标框架 | 仅主分支作业 |
| **Phase 1A** | 战术救援完善 | 实体写库、UI actions、本地链路、风险提醒 | 可开 `feature/rescue-enhance` |
| **Phase 1B** | 战术侦察 & 语音控制 | `ScoutTacticalGraph`、设备控制子图、前端侦察面板 | `feature/scout-graph`、`feature/device-voice`，依赖 Phase 0 |
| **Phase 2** | 战略层智能体 | 战略侦察/救援、SITREP、风险预测子图联动 | 分支需同步使用 Phase 0 底座 |
| **Phase 3** | 安置/补给/扩展 | 安置推荐、补给计划、位置监控扩展 | 视 Phase 2 基座上线后再拆分 |

分支要求：
- 每个子图独立子分支，完成后合并主干；禁止长期悬挂。
- 任何子图上线必须在配置层开启开关，确保回滚不破坏旧链路。
- 变更前更新对应文档章节，保持“文档→代码”一致。

## 9. 日志与指标对照表

| 子图 | 必须日志 | 指标 |
| --- | --- | --- |
| 战术救援 | `rescue_task_completed`、`rescue_ui_actions_emitted`、`route_risk_detected` | `rescue_plan_generation_seconds`, `rescue_ui_actions_total` |
| 战术侦察 | `scout_plan_ready`、`scout_device_allocated` | `scout_plan_generation_seconds` |
| 语音设备控制 | `device_control_issued`、`device_control_ack` | `device_control_latency_seconds`, `device_control_failure_total` |
| 战略侦察/救援 | `strategic_*_generated` | `strategic_plan_duration_seconds` |
| SITREP | `sitrep_compiled`、`sitrep_delivery_*` | `sitrep_generation_seconds` |
| 风险预测 | `risk_assessment_*` | `risk_zone_count`, `risk_assessment_duration_seconds` |
| 位置监控 | `team_position_ingested`、`risk_proximity_alert` | `monitor_alert_total` |

## 10. 下一步行动
1. 完成 Phase 0 底座开发，确认强类型模型与 DAO 到位。
2. 在 `process_intent_core` 中接入 `ui_actions` 返回路径，并更新语音 WebSocket 推送逻辑。
3. 拉通战术救援子图缺口（实体落库、UI actions、风险提醒），并补足日志。
4. 启动战术侦察子图设计评审，明确设备状态数据源与计划结构。
5. 规划语音设备控制协议，与 Adapter Hub 对齐指令格式。
6. 制定战略子图需求细化文档，确认前端展示与接口。
7. 同步前端团队：新增面板、地图图层、风险提示与设备控制 UI。

---
> 所有实现必须遵循“强类型、无降级、日志齐全”的原则；若遇阻无法满足需求，立即同步而非临时兜底。
