# 救援方案全链路展示（乌镇峰会演示指引）

## 1. 场景概览
- **目标：** 面向救灾专家呈现“AI 前突侦察指挥车”如何在紧急场景下自动汇聚情报、生成救援方案，并给出可解释的推荐理由。
- **核心卖点：** 真实数据驱动 + LLM 推理链条透明 + 可视化指挥联动（视角跳转、方案面板、任务下发）。
- **演示入口：**
  1. **自动发现**（无人机/机器狗/哨兵）：设备识别异常 → 自动写入救援实体 → 前端弹窗 & 视角跳转。
  2. **手动标注**：指挥员在地图圈定 → 填写态势摘要 → 一键生成救援方案。
  3. **语音输入**：ASR 转文字 → 意图识别 → 自动生成实体 → 跳转视角并打开方案面板。

以上三条入口最终调用同一救援任务链路，保证演示体验一致且易维护。

## 2. 数据流总览
```text
入口触发 (自动/手动/语音)
        ↓
intent_classifier_node (src/emergency_agents/intent/classifier.py#L20-L132)
        ↓
rescue_task_generation handler (src/emergency_agents/intent/handlers/rescue_task_generation.py#L21-L157)
        ↓
RescueTacticalGraph (src/emergency_agents/graph/rescue_tactical_app.py#L200+)
        ↓
方案草稿 + 实体 + UI Action → REST / WebSocket 推送
        ↓
前端：视角切换 → 方案面板 → 指挥员确认/修改 → 下发任务
```

## 3. 方案结构定义
| 区块 | 字段 | 含义 | 数据来源 / 代码位置 |
| --- | --- | --- | --- |
| `entity` | `entity_id` | 救援实体唯一 ID | handler 生成 UUID<br>`rescue_task_generation.py#L53-L84` |
|  | `location` (`lng`,`lat`,`name`) | 定位信息 | 地理解析 & 设备回传<br>`rescue_tactical_app.py#L208-L233` |
|  | `source` | auto/manual/voice | 入口元数据（由 API 填充） |
| `plan.overview` | `situation_summary` | 当前态势摘要（≥15字） | 意图识别+补全校验<br>`intent/classifier.py#L91-L102` |
|  | `risk_outline` | 风险概览 | LLM 分析输出 |
| `plan.lines[]` | `line_id` / `title` | 每条救援分线 | RAG+知识图谱推理<br>`rescue_tactical_app.py#L272-L344` |
|  | `objectives` | 分线目标说明 | 同上 |
| `plan.resources[]` | `resource_id` / `type` | 推荐队伍/装备 | KG 规则 + RAG 案例匹配 |
|  | `reason` | 推荐理由（含证据引用） | `rescue_task_generation.py#L121-L155` |
| `plan.risks[]` | `hazard` / `mitigation` | 风险提示与缓解措施 | LLM 推理结果 |
| `plan.routeWarnings[]` | `zoneId` / `message` / `resourceIds` | 路线避险提示，指示需要调整的力量 | `rescue_task_generation.py` `_build_route_warnings` |
| `evidence_trace[]` | `type` / `source` / `confidence` | 背后证据链（案例文献、图谱规则、传感器数据） | `rescue_tactical_app.py#L272-L344` 与 RAG Pipeline |
| `ui_actions[]` | `action` / `payload` | 前端应执行的 UI 指令 | 由 orchestrator 汇总返回（需实现） |

> **说明：** 所有结构化字段需通过 JSON 输出，前端可直接渲染；禁止只给长文本。

## 4. 推荐理由拆解逻辑
1. **知识图谱规则匹配**  
   - 查询对应灾害类型的装备需求与部署顺序：`KGService.get_equipment_requirements()`。
   - 结果写入 `kg_requirements`，用于后续推荐理由展示。
2. **RAG 案例检索**  
   - 通过 `RagPipeline.query()` 获取历史案例、应对策略、最佳实践。
   - 将命中的段落编号/标题写入 `rag_cases`，在前端展示“引用案例”链接。
3. **推荐融合**  
   - `build_equipment_recommendations()` 生成每个资源的匹配评分、任务分配建议。
   - 前端需展开显示：“推荐队伍 A1（firefighter）—匹配理由：案例 X + 图谱规则 Y + 当前态势 Z”。
4. **风险分线**  
   - 对每条分线标注风险点（余震、交通阻断、危化品泄露等），并给出缓解措施，便于专家评估。

## 5. 前端交互序列
| 步骤 | 动作 | UI Action 建议 |
| --- | --- | --- |
| 触发入口 | API 返回 `ui_actions` | `{"action":"fly_to","payload":{"lng":103.85,"lat":31.68}}` |
| 弹窗提醒 | 弹出救援目标快照（来源/传感器） | `{"action":"open_modal","payload":{"entity_id":...,"source":"drone"}}` |
| 打开方案面板 | 展示 `plan` 结构 | `{"action":"open_plan_panel","payload":{"plan":...}}` |
| 专家查看推荐理由 | 展示 `evidence_trace` 列表（带来源链接） | 面板内部实现 |
| 自动风险播报 | 输出路线避险提示 | `show_risk_warning` UI Action + 语音播报 |
| 指挥员确认 | 点击“生成救援任务”按钮 | `POST /rescue/draft/{id}/confirm`（待实现） |
| 任务下发 | 更新状态、推送执行态势 | WebSocket 推送 `{"action":"task_issued","payload":...}` |

## 6. 日志与监控建议
| 场景 | 日志 Key | 说明 |
| --- | --- | --- |
| 实体生成 | `rescue_entity_created` | 包含 `entity_id`, `source`, `user_id`, `coordinates` |
| 推荐融合 | `rescue_recommendation_trace` | 记录每条推荐的评分、引用文献、规则 ID |
| UI 推送 | `ui_action_emitted` | 记录动作队列，确保前端同步 |
| 性能监控 | `rescue_plan_generation_seconds` Histogram | 监控端到端耗时 |
| 可信度 | `rag_hit_count`, `kg_requirement_count` | 作为演示时的对外指标 |

> 演示时可同时打开日志面板，实时展示 AI 推理链条，让专家看到“为什么推荐”。

## 7. 乌镇峰会演示脚本（建议）
1. **开场（30 秒）**  
   - 介绍场景：“无人机侦察到新坍塌点，系统自动弹出救援任务草稿。”
2. **自动发现入口**  
   - 展示地图自动跳转、弹窗内容、方案面板，强调推荐理由来源（案例/图谱/传感器）。
3. **手动标注入口**  
   - 在地图手动圈定另一处坍塌点，输入少量态势描述，点击“生成救援方案”，展示结果差异。
4. **语音入口**  
   - 指挥员语音描述第三个救援点，演示 ASR→意图识别→方案生成全过程。
5. **专家互动**  
   - 打开某条推荐，展示“引用案例 + 图谱规则 + 风险缓解措施”的细节。
6. **下发任务**  
   - 点击“生成救援任务”，展示任务状态从 `draft` → `issued`，并推送至执行界面。
7. **结束语**  
   - 强调系统的可解释性、协同能力和真实数据来源，邀请专家提出改进建议。

## 8. 待落实任务（供研发使用）
1. 扩展 `rescue_task_generation` handler 返回结构化 `plan` 与 `evidence_trace`。
2. 在 `process_intent_core` 增加 `ui_actions` 返回值，并在 WebSocket 语音通道同步推送。
3. 设计 `/rescue/draft/{id}/confirm` API，完成任务落地与状态管理。
4. 前端实现方案面板组件，支持分线展示与引用折叠。
5. 补充日志与 Prometheus 指标，确保演示时可实时观测推理链。

完成以上步骤后，即可在乌镇峰会向专业观众展示“真实 AI + 可解释救援方案”的完整能力。

