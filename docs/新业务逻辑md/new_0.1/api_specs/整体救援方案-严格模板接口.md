# 整体救援方案 API（严格模板）

- 路径：`POST /ai/rescue/overall-plan`
- 说明：查询“已选中设备”，由 LLM=glm4.6 根据灾情与事件空间信息选择设备并规划任务，严格按模板返回（带选择理由）。
- Header：`Content-Type: application/json`

## 入参（Body）
- `incident_id: string(UUID)` 事件ID（必填）。
- `time_range_hours: number` 统计范围（1–168，默认24）。

## 返回（JSON）
- `operational_period: { start_iso: string, end_iso: string }` 作战周期（UTC）。
- `assignments: DeviceAssignment[]` 设备分配。
  - `device_id: string` 设备ID（来自选中设备集合）。
  - `choose: boolean` 是否投入；false 时必须给出 `rationale`。
  - `mission: "rescue" | "recon" | "support"` 任务类型。
  - `target_points: { lon:number, lat:number }[]` 位置点，来源于事件空间候选点（或其中心）。
  - `area_radius_m?: number` 侦察/行动范围（米）。
  - `rationale: string` 选择或不选择的原因（专业、可审计）。
- `plan_summary: string` 中文摘要（作战目标→设备分配→关键位置/范围→安全/通信要点）。

## 行为与错误
- 无选中设备 → 400。
- 事件缺少空间几何（event_entities）→ 400。
- LLM 失败或结构不合法 → 500（返回详细错误信息）。

## 说明
- 选中设备规则（与实现一致）：
```sql
SELECT d.id, d.name, d.device_type, d.is_recon
FROM operational.device d
WHERE d.is_recon IS TRUE
  AND COALESCE(d.in_task_use, 0) = 0
  AND EXISTS (
    SELECT 1
    FROM operational.car_device_select cds
    JOIN operational.car_supply_select css
      ON css.car_id = cds.car_id AND css.is_selected = 1
    WHERE cds.device_id = d.id
      AND cds.is_selected = 1
  );
```
- LLM：固定 `glm4.6`，严格 `response_format = json_object`；禁止臆造设备/坐标/字段。
