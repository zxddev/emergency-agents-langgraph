# æ‰¹æ¬¡ä¾¦å¯Ÿå¤©æ°”è¯„ä¼° API - å‰ç«¯å¤©æ°”ä¼ å‚æŒ‡å—

**æ›´æ–°æ—¥æœŸ**: 2025-11-03
**ä¿®æ”¹å†…å®¹**: å¤©æ°”æ•°æ®ä»ç¡¬ç¼–ç æ”¹ä¸ºå‰ç«¯ä¼ å‚

---

## ğŸ“ æ¥å£ä¿¡æ¯

- **è·¯å¾„**: `POST /ai/recon/batch-weather-plan`
- **è¯´æ˜**: æ ¹æ®ç¾æƒ…åœºæ™¯ã€å®æ—¶å¤©æ°”æ¡ä»¶ï¼Œè¯„ä¼°è®¾å¤‡é€‚åº”æ€§å¹¶ç”Ÿæˆæ‰¹æ¬¡ä¾¦å¯Ÿæ–¹æ¡ˆæˆ–å¢æ´å»ºè®®
- **LLMæ¨¡å‹**: å›ºå®šä½¿ç”¨ `glm-4.6`

---

## ğŸ†• æ ¸å¿ƒæ”¹è¿›

### ä¿®æ”¹å‰ï¼ˆç¡¬ç¼–ç ï¼‰
```json
{
  "disaster_type": "flood",
  "epicenter": {"lon": 103.80, "lat": 31.66},
  "severity": "critical",
  "weather_scenario": "heavy_rain"  // âŒ åªèƒ½é€‰é¢„è®¾åœºæ™¯
}
```

### ä¿®æ”¹åï¼ˆå‰ç«¯ä¼ å‚ï¼‰âœ…
```json
{
  "disaster_type": "flood",
  "epicenter": {"lon": 103.80, "lat": 31.66},
  "severity": "critical",
  "weather": {  // âœ… å‰ç«¯ä¼ å…¥å®æ—¶å¤©æ°”æ•°æ®
    "phenomena": ["heavy_rain", "strong_wind"],
    "wind_speed_mps": 15.0,
    "visibility_km": 2.0,
    "precip_mm_h": 6.0
  }
}
```

---

## ğŸ“‹ è¯·æ±‚å‚æ•°è¯¦è§£

### å¿…å¡«å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `disaster_type` | string | ç¾å®³ç±»å‹ | `flood` / `landslide` / `earthquake` / `chemical_leak` |
| `epicenter` | GeoPoint | ç¾å®³ä¸­å¿ƒç‚¹åæ ‡ | `{"lon": 103.80, "lat": 31.66}` |
| `severity` | string | ä¸¥é‡ç¨‹åº¦ | `critical` / `high` / `medium` / `low` |

### å¤©æ°”å‚æ•°ï¼ˆæ¨èä¼ å…¥ï¼‰

#### âœ… æ–¹å¼1ï¼šä¼ å…¥å®æ—¶å¤©æ°”æ•°æ®ï¼ˆæ¨èï¼‰

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|------|
| `weather.phenomena` | string[] | å¿…å¡« | å¤©æ°”ç°è±¡åˆ—è¡¨ | `["heavy_rain", "strong_wind"]` |
| `weather.wind_speed_mps` | float | â‰¥0 | é£é€Ÿï¼ˆç±³/ç§’ï¼‰ | `15.0` |
| `weather.visibility_km` | float | â‰¥0 | èƒ½è§åº¦ï¼ˆå…¬é‡Œï¼‰ | `2.0` |
| `weather.precip_mm_h` | float | â‰¥0 | é™æ°´é‡ï¼ˆæ¯«ç±³/å°æ—¶ï¼‰ | `6.0` |

**å¸¸è§å¤©æ°”ç°è±¡æšä¸¾**ï¼š
- `clear` - æ™´æœ—
- `heavy_rain` - æš´é›¨
- `strong_wind` - å¼ºé£
- `fog` - å¤§é›¾
- `snow` - é™é›ª
- `thunderstorm` - é›·æš´

#### âš ï¸ æ–¹å¼2ï¼šä½¿ç”¨é¢„è®¾åœºæ™¯ï¼ˆå‘åå…¼å®¹ï¼Œå·²åºŸå¼ƒï¼‰

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `weather_scenario` | string | `"heavy_rain"` | é¢„è®¾åœºæ™¯ï¼ˆå·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨ `weather` å­—æ®µï¼‰ |

**å¯é€‰å€¼**:
- `heavy_rain` - æš´é›¨ï¼ˆé£é€Ÿ15m/sï¼Œèƒ½è§åº¦2kmï¼Œé™é›¨6mm/hï¼‰
- `clear` - æ™´æœ—ï¼ˆé£é€Ÿ3m/sï¼Œèƒ½è§åº¦10kmï¼Œæ— é™é›¨ï¼‰

---

## ğŸ“¤ è¿”å›æ•°æ®

### æˆåŠŸå“åº”ï¼ˆè®¾å¤‡è¶³å¤Ÿï¼‰

```json
{
  "success": true,
  "batches": [
    {
      "batch_id": 1,
      "device_id": "device-001",
      "device_name": "æ— äººæœº-01",
      "targets": [
        {
          "id": "target-001",
          "name": "èŒ‚å¿åŒ»é™¢",
          "priority_score": 95.0,
          "lon": 103.85,
          "lat": 31.70
        }
      ],
      "estimated_completion_minutes": 45
    }
  ],
  "reinforcement_request": null,
  "total_targets": 60,
  "suitable_devices_count": 12,
  "estimated_total_hours": 3.5
}
```

### æˆåŠŸå“åº”ï¼ˆè®¾å¤‡ä¸è¶³ - è¿”å›å¢æ´å»ºè®®ï¼‰

```json
{
  "success": true,
  "batches": null,
  "reinforcement_request": {
    "need_reinforcement": true,
    "gap_analysis": "å½“å‰æœ‰60ä¸ªä¾¦å¯Ÿç›®æ ‡ï¼Œä½†åªæœ‰5å°è®¾å¤‡é€šè¿‡å¤©æ°”è¯„ä¼°ï¼Œé¢„è®¡éœ€è¦7å°é¢å¤–è®¾å¤‡",
    "recommended_sources": [
      {
        "source_id": 1,
        "source_name": "æˆéƒ½å¸‚åº”æ€¥æ•‘æ´æ”¯é˜Ÿ",
        "device_types": ["usv"],
        "quantity": 3,
        "response_time_hours": 2.0,
        "rationale": "è¯¥æ”¯é˜Ÿæœ‰3å°æ— äººèˆ¹ï¼Œé€‚åˆæ´ªæ°´ç¯å¢ƒä¸”å“åº”æ—¶é—´æœ€å¿«"
      }
    ],
    "priority_level": "urgent"
  },
  "total_targets": 60,
  "suitable_devices_count": 5,
  "estimated_total_hours": null
}
```

---

## ğŸ§ª æµ‹è¯•ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šæ´ªæ°´ç¾å®³ + æš´é›¨å¤©æ°”ï¼ˆæ¨èæ–¹å¼ï¼‰

```bash
curl -X POST http://localhost:8008/ai/recon/batch-weather-plan \
  -H "Content-Type: application/json" \
  -d '{
    "disaster_type": "flood",
    "epicenter": {"lon": 103.80, "lat": 31.66},
    "severity": "critical",
    "weather": {
      "phenomena": ["heavy_rain", "strong_wind"],
      "wind_speed_mps": 15.0,
      "visibility_km": 2.0,
      "precip_mm_h": 6.0
    }
  }'
```

### ç¤ºä¾‹2ï¼šåŒ–å·¥æ³„éœ² + æ™´æœ—å¤©æ°”

```bash
curl -X POST http://localhost:8008/ai/recon/batch-weather-plan \
  -H "Content-Type: application/json" \
  -d '{
    "disaster_type": "chemical_leak",
    "epicenter": {"lon": 103.80, "lat": 31.66},
    "severity": "high",
    "weather": {
      "phenomena": ["clear"],
      "wind_speed_mps": 3.0,
      "visibility_km": 10.0,
      "precip_mm_h": 0.0
    }
  }'
```

### ç¤ºä¾‹3ï¼šå‘åå…¼å®¹ï¼ˆä¸æ¨èï¼Œä»…ç”¨äºè¿‡æ¸¡ï¼‰

```bash
curl -X POST http://localhost:8008/ai/recon/batch-weather-plan \
  -H "Content-Type: application/json" \
  -d '{
    "disaster_type": "flood",
    "epicenter": {"lon": 103.80, "lat": 31.66},
    "severity": "critical"
    # ä¸ä¼  weather å­—æ®µï¼Œä½¿ç”¨ weather_scenario å…œåº•ï¼ˆé»˜è®¤ heavy_rainï¼‰
  }'
```

---

## âš ï¸ é”™è¯¯å¤„ç†

| HTTP Code | åœºæ™¯ | å¤„ç†å»ºè®® |
|-----------|------|----------|
| 400 | æœªçŸ¥çš„ç¾å®³ç±»å‹ | æ£€æŸ¥ `disaster_type` æ˜¯å¦åœ¨æ”¯æŒåˆ—è¡¨ä¸­ |
| 404 | èŒƒå›´å†…æ— ä¾¦å¯Ÿç›®æ ‡ | è°ƒæ•´ `epicenter` æˆ–ç­‰å¾…ç›®æ ‡æ•°æ®æ›´æ–° |
| 503 | æ— å¯ç”¨ä¾¦å¯Ÿè®¾å¤‡ | æ‰€æœ‰è®¾å¤‡è¢«å ç”¨ï¼Œç¨åé‡è¯• |
| 503 | LLM é…ç½®ç¼ºå¤± | è”ç³»åç«¯æ£€æŸ¥ `RECON_LLM_*` é…ç½® |

---

## ğŸ”§ å‰ç«¯é›†æˆå»ºè®®

### TypeScript ç±»å‹å®šä¹‰

```typescript
interface GeoPoint {
  lon: number;  // ç»åº¦ [-180, 180]
  lat: number;  // çº¬åº¦ [-90, 90]
}

interface WeatherInput {
  phenomena: string[];       // å¤©æ°”ç°è±¡åˆ—è¡¨
  wind_speed_mps: number;    // é£é€Ÿï¼ˆç±³/ç§’ï¼‰â‰¥0
  visibility_km: number;     // èƒ½è§åº¦ï¼ˆå…¬é‡Œï¼‰â‰¥0
  precip_mm_h: number;       // é™æ°´é‡ï¼ˆæ¯«ç±³/å°æ—¶ï¼‰â‰¥0
}

interface BatchWeatherPlanRequest {
  disaster_type: 'flood' | 'landslide' | 'earthquake' | 'chemical_leak';
  epicenter: GeoPoint;
  severity: 'critical' | 'high' | 'medium' | 'low';
  weather?: WeatherInput;  // å¯é€‰ï¼šæ¨èä¼ å…¥
  weather_scenario?: 'heavy_rain' | 'clear';  // å¯é€‰ï¼šå·²åºŸå¼ƒ
}
```

### JavaScript è°ƒç”¨ç¤ºä¾‹

```javascript
// ä»å¤©æ°”APIè·å–å®æ—¶æ•°æ®
const weatherData = await fetchWeatherFromAPI();

// æ„é€ è¯·æ±‚
const response = await fetch('/ai/recon/batch-weather-plan', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    disaster_type: 'flood',
    epicenter: { lon: 103.80, lat: 31.66 },
    severity: 'critical',
    weather: {
      phenomena: weatherData.phenomena,
      wind_speed_mps: weatherData.windSpeed,
      visibility_km: weatherData.visibility,
      precip_mm_h: weatherData.precipitation
    }
  })
});

const result = await response.json();

if (result.batches) {
  console.log('è®¾å¤‡è¶³å¤Ÿï¼Œå·²ç”Ÿæˆæ‰¹æ¬¡æ–¹æ¡ˆ');
  displayBatches(result.batches);
} else if (result.reinforcement_request) {
  console.log('è®¾å¤‡ä¸è¶³ï¼Œéœ€è¦å¢æ´');
  displayReinforcementRequest(result.reinforcement_request);
}
```

---

## ğŸ“Š ç¾å®³ç±»å‹ä¸ä¾¦å¯ŸåŠå¾„

| ç¾å®³ç±»å‹ | ä¾¦å¯ŸåŠå¾„ | é€‚ç”¨åœºæ™¯ |
|---------|---------|---------|
| `flood` | 30km | æ´ªæ°´å¯èƒ½æ²¿æ²³é“æ‰©æ•£ |
| `earthquake` | 50km | å½±å“èŒƒå›´æœ€å¹¿ï¼Œæ¬¡ç”Ÿç¾å®³åˆ†æ•£ |
| `landslide` | 10km | å±€éƒ¨ç¾å®³ï¼Œå½±å“èŒƒå›´æœ‰é™ |
| `chemical_leak` | 5km | é«˜å±éœ€ç²¾ç¡®æ§åˆ¶ï¼Œé¿å…ææ…Œ |

---

## ğŸ¯ æœ€ä½³å®è·µ

1. **ä¼˜å…ˆä½¿ç”¨ `weather` å­—æ®µ**ï¼šå‰ç«¯é›†æˆå®æ—¶å¤©æ°”APIï¼ˆå¦‚OpenWeatherMapã€ä¸­å›½å¤©æ°”ç½‘ï¼‰
2. **æ•°æ®æ ¡éªŒ**ï¼šç¡®ä¿å¤©æ°”å‚æ•° â‰¥ 0ï¼ˆé£é€Ÿã€èƒ½è§åº¦ã€é™æ°´é‡ï¼‰
3. **é™çº§ç­–ç•¥**ï¼šå¤©æ°”APIä¸å¯ç”¨æ—¶ï¼Œå¯ä¸ä¼  `weather` å­—æ®µï¼Œä½¿ç”¨é¢„è®¾å…œåº•
4. **æ—¥å¿—è¿½è¸ª**ï¼šåç«¯ä¼šè®°å½• `has_custom_weather` å­—æ®µï¼Œä¾¿äºè¿½è¸ªä½¿ç”¨æƒ…å†µ
5. **å‘åå…¼å®¹**ï¼š`weather_scenario` å­—æ®µä¿ç•™ï¼Œä½†å»ºè®®é€æ­¥è¿ç§»åˆ° `weather`

---

## ğŸ”„ å‡çº§è·¯å¾„

### é˜¶æ®µ1ï¼šå…±å­˜ï¼ˆå½“å‰ï¼‰
- åŒæ—¶æ”¯æŒ `weather` å’Œ `weather_scenario`
- `weather` ä¼˜å…ˆçº§æ›´é«˜

### é˜¶æ®µ2ï¼šè¿‡æ¸¡ï¼ˆ1ä¸ªæœˆåï¼‰
- å‰ç«¯å…¨é¢è¿ç§»åˆ° `weather` å­—æ®µ
- `weather_scenario` æ ‡è®°ä¸º deprecated

### é˜¶æ®µ3ï¼šæ¸…ç†ï¼ˆ3ä¸ªæœˆåï¼‰
- ç§»é™¤ `weather_scenario` å­—æ®µ
- ç§»é™¤ `_get_weather_condition` å‡½æ•°

---

## ğŸ“ æ›´æ–°æ—¥å¿—

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´è¯´æ˜ |
|------|------|---------|
| 2025-11-03 | v2.0 | æ”¯æŒå‰ç«¯ä¼ å…¥å®æ—¶å¤©æ°”æ•°æ®ï¼ˆ`weather` å­—æ®µï¼‰ |
| 2025-11-02 | v1.0 | åˆå§‹ç‰ˆæœ¬ï¼ˆä»…æ”¯æŒ `weather_scenario` é¢„è®¾åœºæ™¯ï¼‰ |

---

## ğŸ†˜ å¸¸è§é—®é¢˜

**Q: å¦‚æœåŒæ—¶ä¼  `weather` å’Œ `weather_scenario` ä¼šæ€æ ·ï¼Ÿ**
A: `weather` ä¼˜å…ˆçº§æ›´é«˜ï¼Œ`weather_scenario` ä¼šè¢«å¿½ç•¥ã€‚

**Q: ä¸ä¼  `weather` å­—æ®µä¼šæŠ¥é”™å—ï¼Ÿ**
A: ä¸ä¼šæŠ¥é”™ï¼Œä¼šä½¿ç”¨ `weather_scenario` å…œåº•ï¼ˆé»˜è®¤ `heavy_rain`ï¼‰ã€‚

**Q: å¤©æ°”ç°è±¡å¯ä»¥è‡ªå®šä¹‰å—ï¼Ÿ**
A: å¯ä»¥ï¼ŒLLM ä¼šç†è§£è‡ªç„¶è¯­è¨€æè¿°ã€‚ä½†å»ºè®®ä½¿ç”¨å¸¸è§æšä¸¾å€¼ç¡®ä¿å‡†ç¡®æ€§ã€‚

**Q: å¦‚ä½•è·å–å®æ—¶å¤©æ°”æ•°æ®ï¼Ÿ**
A: æ¨èæ¥å…¥ OpenWeatherMap API æˆ–ä¸­å›½å¤©æ°”ç½‘ APIã€‚

---

**æŠ€æœ¯æ”¯æŒ**: emergency-agents-langgraph å¼€å‘å›¢é˜Ÿ
**æ–‡æ¡£ç‰ˆæœ¬**: v2.0 (2025-11-03)
