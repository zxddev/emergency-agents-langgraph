# 侦察方案 API（优先目标约束，固定 glm-4.6）

- 路径：`POST /ai/recon/priority-plan`
- 说明：
  - 仅使用数据库"选中且空闲的侦察设备"与 `operational.recon_priority_targets` 重点目标生成"真实可执行"的侦察方案。
  - 模型固定 `glm-4.6`，严格 JSON 模板输出；不兜底、不降级。
  - **配置回退**：优先使用 `RECON_LLM_BASE_URL` / `RECON_LLM_API_KEY`，未配置时自动回退到项目通用配置 `OPENAI_BASE_URL` / `OPENAI_API_KEY`。

## 入参（Body）
- `incident_id: string(UUID)` 事件ID（必填）。
- `time_range_hours: number` 统计窗口（1–168，默认24）。
- `hazard_scenario: string` 灾情关键词（如 `flood`/`chemical_leak`/`landslide`）。
- `radius_km: number` 重点目标检索半径（默认30，范围1–80）。
- `max_targets: number` 取目标上限（默认60，范围1–200）。

## 返回（JSON）
- `operational_period: { start_iso: string, end_iso: string }`
- `assignments: DeviceAssignment[]`
  - `device_id: string`（来自选中设备集合）
  - `choose: boolean`（false 时必须给 `rationale`）
  - `mission: "recon"`（固定为侦察）
  - `target_id: string`（必须来自 priority_targets）
  - `target_name: string`、`target_type: string`
  - `target_points: {lon,lat}[]`（必须与该 `target_id` 数据库坐标一致）
  - `area_radius_m?: number`
  - `rationale: string`
  - 执行参数：`pattern|duration_min|speed_kmh|altitude_m|depth_m|sensors|comms_channel`
- `plan_summary: string`（中文摘要）
 - `no_suitable_equipment?: boolean` 若为 true 表示本轮无可用装备
 - `recommendations?: { category:string, capabilities:string[], suggested_quantity:number, rationale:string, source:string }[]`
   - 当 `no_suitable_equipment=true` 时返回，表示按灾情策略+LLM(glm-4.6) 生成且已过滤的不违规推荐装备

## 设备筛选 SQL（实现一致）
```sql
SELECT d.id, d.name, d.device_type, d.is_recon
FROM operational.device d
WHERE d.is_recon IS TRUE
  AND COALESCE(d.in_task_use, 0) = 0
  AND EXISTS (
    SELECT 1
    FROM operational.car_device_select cds
    JOIN operational.car_supply_select css
      ON css.car_id = cds.car_id AND css.is_selected = 1
    WHERE cds.device_id = d.id
      AND cds.is_selected = 1
  );
```

## 重点目标查询（简述）
- 表：`operational.recon_priority_targets`（已提供茂县近百条种子数据）
- 半径过滤：`ST_DWithin(location, center, radius_km*1000)`；按 `hazard_level/priority` 排序

## 配置说明

### LLM 配置回退逻辑
接口支持灵活的配置方式，优先使用专用配置，未配置时自动回退到项目通用配置：

| 配置场景 | 环境变量 | 说明 |
|---------|---------|------|
| **方式1：专用配置** | `RECON_LLM_BASE_URL`<br>`RECON_LLM_API_KEY` | 为侦察接口单独配置 LLM 端点和密钥（用于成本隔离、限流等高级场景） |
| **方式2：通用配置** | `OPENAI_BASE_URL`<br>`OPENAI_API_KEY` | 使用项目统一的 LLM 配置（推荐开发环境） |
| **方式3：混合** | 两者都配置 | 优先使用 `RECON_LLM_*`，保证侦察接口独立性 |

### 配置示例

#### 开发环境（最简配置）
```bash
# 仅配置通用 LLM，所有接口共用
OPENAI_BASE_URL=https://open.bigmodel.cn/api/paas/v4
OPENAI_API_KEY=your_api_key_here
LLM_MODEL=glm-4-flash
```

#### 生产环境（成本隔离）
```bash
# 通用配置（快速模型）
OPENAI_BASE_URL=https://open.bigmodel.cn/api/paas/v4
OPENAI_API_KEY=key_for_general_purpose
LLM_MODEL=glm-4-flash

# 侦察专用配置（高质量模型 + 独立密钥）
RECON_LLM_BASE_URL=https://open.bigmodel.cn/api/paas/v4
RECON_LLM_API_KEY=key_for_reconnaissance_only
RECON_LLM_MODEL=glm-4.6
```

### 配置验证
接口启动时会自动验证配置，确保至少有一组有效配置：
- ✅ `RECON_LLM_*` 配置完整 → 使用专用配置
- ✅ `OPENAI_*` 配置完整 → 回退到通用配置
- ❌ 两者都未配置 → 返回 `503 Service Unavailable`

## 错误
- 503: `RECON_LLM_*` 和 `OPENAI_*` 均未配置（配置缺失）。
- 400: 无可用设备 / 无重点目标 / 事件缺少空间几何。
  - 注意：当"全部 choose=false"（无合适装备）时，本接口不再返回 400，而是 `200 + { no_suitable_equipment:true, recommendations:[...] }`
- 500: 上游模型失败或 LLM 返回结构不合法（服务端强校验）。

## 代码位置
- 路由：`src/emergency_agents/api/recon_priority.py:1`
- main 绑定：`src/emergency_agents/api/main.py:260`、`src/emergency_agents/api/main.py:515`

```bash
curl -X POST http://<host:port>/ai/recon/priority-plan \
  -H 'Content-Type: application/json' \
  -d '{
    "incident_id":"fef8469f-5f78-4dd4-8825-dbc915d1b630",
    "hazard_scenario":"flood",
    "time_range_hours":24,
    "radius_km":30,
    "max_targets":60
  }'
```
