# 风险预测与路线避险设计（规划说明）

## 1. 背景
- 当前战术救援子图已能生成救援方案，但缺乏“危险区域识别、路径避险提醒”能力。
- 演示需求：化工厂泄漏、河道洪水等风险需要定时监测，并在推荐路线与任务面板中给出明确提醒。

## 2. 核心目标
1. **定时风险预测子图**：维持最新风险区域数据（多源信息汇聚）。
2. **风险区域表**：记录区域几何、有效时间、危险级别。
3. **路线避险判断**：救援任务在规划路线时检测风险。
4. **前端展示**：地图高亮风险区域、方案面板提示“预计多少分钟后遇到危险”。

## 3. 风险预测子图概览
| 步骤 | 说明 | 代码定位（目标） |
| --- | --- | --- |
| 数据采集 | 定时调度 (Cron) 汇总传感器、外部 API、人工上报 | `src/emergency_agents/risk/predictor.py`（待新增） |
| 风险评分 | 根据危险类型（化工泄漏、余震、洪水等）评估等级/影响范围 | 子图节点：`risk_evaluate` |
| 数据入库 | 写入 `risk_zones` 表（见下一节） | DAO 层 `src/emergency_agents/risk/repository.py` |
| 缓存与通知 | 更新内存缓存，必要时通知救援子图刷新 | 触发 `risk_assessment_completed` 日志 |

## 4. 数据表设计（示例）
`risk_zones`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `zone_id` | UUID | 主键 |
| `category` | text | 风险类别（chemical_leak / flood / aftershock 等） |
| `severity` | int | 风险等级（1-5） |
| `geometry` | geometry(Polygon/MultiPolygon) | 风险区域（支持缓冲带） |
| `start_time` / `end_time` | timestamptz | 有效时间区间 |
| `source` | text | 数据来源（sensor/api/manual） |
| `metadata` | jsonb | 其他信息（预测模型、采样值） |
| `created_at` / `updated_at` | timestamptz | 记录维护 |

> 可额外维护 `risk_lines` 表存放分线/缓冲信息，供路线详细提示使用。

## 5. 路线避险判定流程
1. `route_planning` 节点拿到高德驾车路线（列表：distance、duration、polyline）。
2. 将 polyline 采样成点或缓冲线段，与 `risk_zones.geometry` 做空间相交判断。
3. 若命中风险区域，则记录：
   - 风险类别 / 级别；
   - 进入风险的大致时间（累计里程→时间换算）；
   - 建议措施（绕行/减速/救援装备要求）。
4. 返回结构中增加 `route_warnings[]`，同时在 `plan.risks[]` 中补充“分线风险”描述。

### 判定算法建议
```text
路线 polyline → 以每 500m 采样节点 → 对应时间 = (累计路程 / 总路程) * duration
对每个节点/线段执行 ST_Intersects(risk_zone.geometry, node_buffer)
若命中 → 生成 warning：{ riskType, severity, timeToRisk, distanceAhead, recommendedAction }
```

## 6. 前端展示要求
| 模块 | 行为 |
| --- | --- |
| 地图 | 渲染风险区域图层（颜色/动画区分），路线节点若进入危险区域，展示闪烁/图标提示 |
| 方案面板 | 在 `plan.risks[]` 中列出“预计 X 分钟后接近危险区域 Y，建议 ...” |
| 通知 | `ui_actions` 增加 `show_risk_warning` 提醒指挥员 |
| 日志 | 记录 `route_risk_detected`，供演示时追踪 |

## 7. TODO / 实现清单
1. **风险子图代码结构**：
   - 模块 `src/emergency_agents/risk/`：`predictor.py`、`repository.py`、`models.py`、`scheduler.py`。
   - 定时任务可使用 APScheduler / asyncio Task（遵守强类型）。
2. **路线避险扩展**：
   - 在 `route_planning` 节点调用 `risk_repository.find_zones(dest_coord)`→判定。
   - 新增 `route_warnings`、`plan.risks` 字段。
3. **前端模块**：
   - 风险图层渲染与路线提示（消费新增字段）。
   - 新 UI action `show_risk_warning`。
4. **日志与监控**：
   - `risk_assessment_start/complete`、`risk_zone_update`、`route_risk_detected`。
   - Prometheus 指标 `risk_zone_count`, `risk_assessment_duration_seconds`。
5. **文档追踪**：
   - 与 `救援方案全链路展示.md`、`战术救援子图拆分.md` 交叉引用，后续开发完成后同步更新。

## 8. 与现有流程的衔接
- 风险子图输出写表后，`RescueTacticalGraph` 可在 `route_planning` 前读取缓存/数据库。
- 对于语音/手动入口，风险提醒也在本地流程中展示；对于广播入口，通知只发送简短风险提示，避免重复数据。

---
> 后续开发需严格遵守强类型、无降级等约束；每个新增方法添加简明中文注释，记录订阅和推送接口位置，便于审阅与排障。
