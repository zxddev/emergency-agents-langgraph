# 意图编排与会话链路重构

## 1. LangGraph 编排子图
- 状态结构 `IntentOrchestratorState` 明确线程、通道、记忆命中等字段，保证节点间传递信息一致性（`src/emergency_agents/graph/intent_orchestrator_app.py:21`）。
- 图节点划分：`ingest → classify → validate → (prompt|route|failure)`，每步写入审计日志，便于排障（`src/emergency_agents/graph/intent_orchestrator_app.py:61-205`）。
- 路由映射统一产出 `router_next`，目前覆盖救援、设备控制、UI 控制等意图类型，未知意图落入 `unknown`，上层返回兜底提示（`src/emergency_agents/graph/intent_orchestrator_app.py:136-173`）。

## 2. 意图处理主流程
- `process_intent_core` 先落盘用户消息，再拉取最近 50 条历史，构造 LangGraph 消息列表，同时将 mem0 搜索结果注入上下文（`src/emergency_agents/api/intent_processor.py:98-165`）。
- mem0 检索与写入都通过回调记录 Prometheus 指标，失败直接抛出，符合“不做降级”约束（`src/emergency_agents/api/intent_processor.py:115-130`、`279-290`）。
- 记忆文本自动解析出 `event_type`、`mission_type` 等字段，填充 `conversation_context`，供救援任务子图继承现场语义（`src/emergency_agents/api/intent_processor.py:48-77`、`132-165`、`259-268`）。
- 救援任务意图新增强校验：`validator` 对 `RESCUE_TASK_GENERATION` 强制检查 `mission_type`、`coordinates.lat/lng` 与 `situation_summary`（≥15字），缺失时返回 `needs_input` 并触发追问（`src/emergency_agents/intent/validator.py:47-79`、`src/emergency_agents/intent/providers/llm.py:20-87`）。
- 验证失败直接返回追问提示并写入助手消息；验证成功后按照路由查表获取 Handler，实例化槽位 dataclass，执行原有业务逻辑（`src/emergency_agents/api/intent_processor.py:188-268`）。

## 3. FastAPI 接入与指标
- Postgres 连接池、Adapter Hub、Amap、Orchestrator 全部在模块初始化阶段创建，并在 `startup/shutdown` 生命周期统一开启与关闭（`src/emergency_agents/api/main.py:124-247`）。
- `/intent/process` 调用主流程前合并 `metadata` 与 `incident_id`，并返回 history、memory_hits、audit_log 供前端直接展示（`src/emergency_agents/api/main.py:489-518`）。
- `/conversations/history` 先校验线程归属，再返回完整消息数组，字段包含角色、内容、意图类型和时间戳（`src/emergency_agents/api/main.py:521-542`）。
- mem0 相关 Counter/Histogram 在模块级注册，工厂函数 `_mem0_metrics_factory` 注入到核心逻辑，使单元测试能通过 mock 直接覆盖指标（`src/emergency_agents/api/main.py:68-84`、`223-230`）。

## 4. 语音通道复用
- WebSocket 语音入口复用同一处理流程：在 ASR 输出后导入新的 orchestrator、history builder 与指标工厂，确保语音与文本行为一致（`src/emergency_agents/api/voice_chat.py:254-289`）。

## 5. 依赖与回顾
- 所有 Python 源文件均补齐类型注解，新引入模块无动态类型残留。
- 旧版 `process_intent_core` 清空后留下的 API 缺口已恢复：REST/WS 均可调用，Prometheus 指标按需求暴露。
- 默认事件兜底逻辑集中在常量 `RESCUE_DEMO_INCIDENT_ID`，无魔法字符串散落。
