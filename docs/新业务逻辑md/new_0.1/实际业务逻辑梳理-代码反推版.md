# 实际业务逻辑梳理（代码反推版）

**生成日期**: 2025-11-02
**分析方法**: 从代码库逐层反推，识别已实现vs待开发功能
**核心原则**: 不依赖可能过时的文档，仅基于实际代码

---

## 1. 核心发现：文档与代码的重大差异

### 1.1 文档说"待实现" → 实际已完成

| 功能模块 | 文档描述 | 实际代码状态 | 代码位置 |
|---------|---------|------------|---------|
| **救援草稿API** | 待实现 | ✅ 完整实现 | `services/rescue_draft_service.py`<br>`api/rescue.py` |
| **风险预测** | 待开发RiskPredictionGraph | ✅ 后台服务已运行 | `api/main.py:407-413`<br>`RiskPredictor.run_periodic()` |
| **设备控制** | 待完善语音设备控制 | ✅ 完整实现 | `intent/handlers/device_control.py`<br>通用+机器狗专用Handler |
| **任务确认API** | 待实现 | ✅ 完整实现 | `api/rescue.py:69-93`<br>`POST /rescue/drafts/{id}/confirm` |
| **风险缓存** | 未提及 | ✅ 定期刷新机制 | `api/main.py:396-420`<br>`RiskCacheManager` |

### 1.2 文档未提及 → 实际存在的系统

| 系统 | 功能描述 | 代码位置 |
|------|---------|---------|
| **独立方案规划系统** | 基于评分的COA生成、多灾种规划 | `api/plan.py`<br>POST `/ai/plan/recommend`<br>POST `/ai/plan/multi-hazard` |
| **车载系统API** | 视觉分析、装备推荐、任务分配 | `api/vehicle.py`<br>3个完整API端点 |
| **完整Prometheus监控** | 日志指标、性能指标 | `logging.py`（Phase0新增）<br>各模块内Prometheus埋点 |

### 1.3 文档说已完成 → 实际是占位实现

| 功能 | 代码状态 | 证据 |
|------|---------|------|
| **视频分析** | ⚠️ 占位实现 | `intent/handlers/video_analysis.py:45-54`<br>返回 `"status": "pending_pipeline"` |

---

## 2. 实际业务架构（四层模型）

### Layer 1: FastAPI路由层

**已注册的路由**（从 `main.py` 确认）:

```python
# 核心API端点
POST   /intent/process              # 统一意图处理入口
POST   /conversations/history       # 会话历史查询
POST   /assist/answer              # RAG问答
WebSocket /ws/voice/chat           # 语音对话WebSocket

# 救援相关
GET    /rescue/drafts/{draft_id}          # 获取草稿
POST   /rescue/drafts/{draft_id}/confirm  # 确认草稿生成任务

# 方案规划（独立系统）
POST   /ai/plan/recommend          # 救援方案推荐（COA生成）
POST   /ai/plan/multi-hazard       # 多灾种任务规划

# 车载系统
POST   /vehicle/vision/analyze     # 视觉分析
POST   /vehicle/equipment/recommend # 装备推荐
POST   /vehicle/task/allocate       # 任务分配优化

# 监控
GET    /healthz                     # 健康检查
GET    /metrics                     # Prometheus指标
```

### Layer 2: Intent Handler层

**已实现的7个Handler**（从 `intent/handlers/` 目录确认）:

| Handler | 文件 | 大小 | 状态 | 说明 |
|---------|------|------|------|------|
| `rescue_task_generation` | rescue_task_generation.py | 46KB | ✅ 完整 | 救援任务生成，功能最复杂 |
| `scout_task_generation` | scout_task_generation.py | 3KB | ✅ 基础 | 侦察任务生成，功能简单 |
| `device_control` | device_control.py | 9KB | ✅ 完整 | 通用设备控制+机器狗专用 |
| `location_positioning` | location_positioning.py | 5KB | ✅ 完整 | 位置定位 |
| `task_progress` | task_progress.py | 4KB | ✅ 完整 | 任务进度查询 |
| `ui_control` | ui_control.py | 2KB | ✅ 完整 | UI控制 |
| `video_analysis` | video_analysis.py | 2KB | ⚠️ 占位 | 视频分析（待完善） |

### Layer 3: LangGraph子图层

**启动时注册的子图**（从 `main.py:startup_event` 确认）:

```python
# 第1个子图：救援应用图
_graph_app = await build_app(
    _cfg.checkpoint_sqlite_path,
    _cfg.postgres_dsn
)
logger.info("api_graph_ready", graph="rescue_app")

# 第2个子图：意图编排图
_intent_graph = await build_intent_orchestrator_graph(
    cfg=_cfg,
    llm_client=_intent_llm_client,
    # ...
)
logger.info("api_graph_ready", graph="intent_orchestrator")

# 第3个子图：语音控制图
_voice_control_graph = await build_voice_control_graph(
    pipeline=_voice_control_pipeline,
    adapter_client=_adapter_client,
    postgres_dsn=_cfg.postgres_dsn,
)
logger.info("api_graph_ready", graph="voice_control")
```

**子图详细说明**:

| 子图 | 代码文件 | 节点流程 | State类型 | 问题 |
|------|---------|---------|----------|------|
| **rescue_app** | `graph/rescue_tactical_app.py` | resolve_location → kg_requirement_lookup → rag_case_retrieval → resource_matcher → route_planning → persist_task | `RescueTacticalState` | ❌ 使用 `total=False` |
| **intent_orchestrator** | `graph/intent_orchestrator_app.py` | ingest → classify → validate → (prompt\|route\|failure) | `IntentOrchestratorState` | ❌ 使用 `total=False` |
| **voice_control** | `graph/voice_control_app.py` | 待查看 | `VoiceControlState` | 待确认 |
| **scout_tactical** | `graph/scout_tactical_app.py` | 简化实现（基于风险区域） | `ScoutTacticalState` | ❌ 使用 `total=False` |
| **recon_app** | `graph/recon_app.py` | 待查看 | 待确认 | 待确认 |

### Layer 4: Service/Repository层

**已实现的服务**:

| 服务类 | 文件 | 功能 | 依赖 |
|--------|------|------|------|
| `RescueDraftService` | services/rescue_draft_service.py | 草稿保存/加载/确认 | IncidentSnapshotRepository |
| `RiskCacheManager` | 未找到单独文件（在main.py引用） | 风险缓存管理 | IncidentDAO |
| `RiskPredictor` | 未找到单独文件 | 风险预测（定期运行） | RiskDataRepository |
| `ConversationManager` | memory/conversation_manager.py | 会话历史管理 | PostgreSQL |
| `Mem0Facade` | memory/mem0_facade.py | 长期记忆管理 | Mem0 |

---

## 3. Phase0修复状态确认

**已完成的Phase0修复**（从 `docs/new_0.1/Phase0-修复完成报告.md` 确认）:

| 修复项 | 状态 | 代码位置 | 说明 |
|-------|------|---------|------|
| ✅ @task装饰器 | 完成 | `graph/rescue_tactical_app.py:117-210` | 8个副作用操作已包装 |
| ✅ durability配置 | 完成 | 7个文件，11个调用点 | 长流程sync、中流程async、短流程exit |
| ✅ 统一日志模块 | 完成 | `logging.py` + `main.py:352-356` | trace-id中间件、Prometheus指标 |
| ⏸️ State定义规范 | 暂缓 | 所有图仍用 `total=False` | 新子图需遵循新规范 |

**遗留问题**:
- 所有现有子图的State定义仍使用 `TypedDict(total=False)`
- 违反"强类型第一"原则
- **新开发的子图必须使用 `Required`/`NotRequired` 模式**

---

## 4. 真实业务逻辑链路

### 4.1 救援任务全链路

```
入口触发（自动/手动/语音）
    ↓
POST /intent/process
    ↓
IntentOrchestratorGraph
    → classify (意图分类)
    → validate (槽位验证)
    → route (路由到Handler)
    ↓
RescueTaskGenerationHandler
    → 调用 RescueTacticalGraph
    ↓
RescueTacticalGraph (LangGraph子图)
    → resolve_location (@task: 高德地理编码)
    → query_resources (查询可用资源)
    → kg_reasoning (知识图谱推理)
    → rag_analysis (@task: RAG案例检索)
    → route_planning (@task: 高德路径规划)
    → persist_task (@task: 写入数据库)
    → ws_notify (WebSocket通知)
    ↓
返回结果
    → rescue_task (方案主体)
    → routes (路径数据)
    → recommendations (推荐资源)
    → ui_actions (前端UI指令)
```

**关键特性**:
- ✅ @task包装确保幂等性
- ✅ durability="sync" 确保故障恢复
- ❌ State仍用total=False（待迁移）

### 4.2 救援草稿确认链路

```
AI生成方案
    ↓
RescueDraftService.save_draft()
    → 写入 incident_snapshots 表
    → snapshot_type = "rescue_plan_draft"
    ↓
前端展示草稿
    ↓
指挥员确认
    ↓
POST /rescue/drafts/{draft_id}/confirm
    ↓
RescueDraftService.confirm_draft()
    → 创建 rescue_tasks 表记录
    → 删除原始草稿
    ↓
任务下发
```

**证据代码位置**:
- 保存: `services/rescue_draft_service.py:53-94`
- 加载: `services/rescue_draft_service.py:96-122`
- 确认: `services/rescue_draft_service.py:124-179`
- API: `api/rescue.py:48-93`

### 4.3 风险预测链路

```
应用启动
    ↓
main.py:startup_event
    → RiskCacheManager.prefetch()
    → RiskPredictor.analyze()
    → 启动定期刷新任务
    ↓
后台定期运行（每N秒）
    → RiskPredictor.run_periodic()
    → 分析风险区域
    → 更新缓存
    ↓
其他模块调用
    → risk_cache_manager.get_active_zones()
```

**证据代码位置**:
- 启动: `main.py:396-420`
- 缓存管理器: `main.py:397-402`
- 预测器: `main.py:407-413`
- 定期任务: `main.py:411-413`

---

## 5. 待开发/完善的真实需求

### 5.1 确认待开发的功能

基于代码分析，**真正缺失的功能**:

| 功能 | 文档状态 | 代码状态 | 优先级 | 说明 |
|------|---------|---------|--------|------|
| **视频分析完整实现** | 说已完成 | ⚠️ 占位 | P0 | video_analysis.py仅返回pending_pipeline |
| **侦察子图完善** | 待开发 | ⚠️ 简化版 | P1 | scout_tactical_app.py缺少设备选择、航线规划 |
| **UI Actions返回机制** | 待实现 | ⚠️ 部分实现 | P1 | 文档要求统一返回ui_actions，实际部分Handler未返回 |
| **实体写库接口** | 待实现 | ⚠️ 部分实现 | P1 | 通过snapshot保存，但缺少直接entity写入接口 |
| **State定义规范迁移** | Phase0遗留 | ❌ 未开始 | P2 | 所有子图需迁移到Required/NotRequired模式 |

### 5.2 文档规划但可能不需要的功能

| 文档规划 | 实际情况 | 建议 |
|---------|---------|------|
| **RiskPredictionGraph** | RiskPredictor后台服务已实现 | ✅ 无需额外开发，可能需要增强 |
| **战略救援规划Graph** | `/ai/plan/*` API已实现类似功能 | ⚠️ 需确认是否重复，建议复用现有系统 |
| **RouteRiskGuard子图** | rescue_tactical_app中已有风险提醒逻辑 | ⚠️ 需确认是否需要独立子图 |

---

## 6. 关键技术债务

### 6.1 State定义不符合强类型要求

**问题**:
所有现有子图使用 `TypedDict(total=False)`，导致：
- 类型检查器无法捕获缺字段错误
- 运行时可能出现KeyError
- 违反"强类型第一"原则

**证据**:
```python
# rescue_tactical_app.py:90
class RescueTacticalState(TypedDict, total=False):  # ❌ 错误模式
    task_id: str  # 实际上变成可选
    user_id: str  # 实际上变成可选
    # ...

# 正确模式（应该用）:
class RescueTacticalState(TypedDict):
    task_id: str  # 必填
    user_id: str   # 必填
    slots: NotRequired[RescueTaskGenerationSlots]  # 可选
```

**影响范围**:
- `RescueTacticalState` (rescue_tactical_app.py)
- `IntentOrchestratorState` (intent_orchestrator_app.py)
- `ScoutTacticalState` (scout_tactical_app.py)
- 其他所有辅助TypedDict

**解决方案**:
参考 `docs/guides/state-coding-standards.md`（Phase0已创建）

### 6.2 视频分析占位实现

**问题**: `video_analysis.py` 返回硬编码的占位响应

**证据**:
```python
# video_analysis.py:45-54
message = (
    f"已进入视频流分析流程（{device.name or device.id}）。"
    " 当前阶段为占位实现，等待视频处理模块接入。"
)
payload = {
    "status": "pending_pipeline",  # ⚠️ 占位状态
    # ...
}
```

**需求**: 接入真实的视频处理管道（GLM-4V/YOLO等）

---

## 7. 开发建议

### 7.1 优先级排序

**P0（立即处理）**:
1. 视频分析完整实现（对接GLM-4V或YOLO）
2. 确认UI Actions返回机制并统一实现

**P1（本周完成）**:
1. 侦察子图完善（设备选择、航线规划）
2. State定义规范迁移（新子图先用新规范）
3. 实体写库接口补充（直接entity写入）

**P2（下周开始）**:
1. 现有子图State迁移（rescue/scout/intent等）
2. 战略层功能（评估是否复用现有 `/ai/plan/*`）

### 7.2 开发原则

基于代码分析，确认以下原则：

1. **强类型第一**: 新开发子图必须使用 `Required`/`NotRequired` 模式
2. **@task包装**: 所有副作用操作必须用 `@task` 包装
3. **durability配置**: 所有invoke必须显式配置durability
4. **不做降级**: 视频分析等占位实现必须替换为真实实现，不允许fallback
5. **日志齐全**: 使用统一日志模块 `logging.py`

---

## 8. 下一步行动

### 8.1 立即确认的问题（需要用户澄清）

1. **视频分析需求**:
   - 是否对接GLM-4V？
   - 还是使用YOLO/其他方案？
   - 输入/输出格式要求？

2. **方案规划系统**:
   - `/ai/plan/*` 与 RescueTacticalGraph 的关系？
   - 是否需要合并或废弃其中一个？

3. **侦察子图**:
   - 设备选择逻辑：从哪里获取设备列表？
   - 航线规划：使用高德API还是其他？

### 8.2 代码层面的TODO

```python
# 1. 视频分析Handler完善
# 文件: intent/handlers/video_analysis.py
# TODO: 替换占位实现，对接真实视频处理管道

# 2. 侦察子图完善
# 文件: graph/scout_tactical_app.py
# TODO: 添加 device_selection 节点
# TODO: 添加 recon_route_planning 节点
# TODO: 添加 sensor_payload_assignment 节点

# 3. State定义迁移（新子图）
# TODO: 创建新子图时使用 Required/NotRequired 模式
# 参考: docs/guides/state-coding-standards.md

# 4. UI Actions统一返回
# TODO: 检查所有Handler，确保返回ui_actions字段
# TODO: 定义ui_actions的JSON schema
```

---

## 9. 附录：重要代码位置索引

### 9.1 核心子图
- 救援战术图: `graph/rescue_tactical_app.py`
- 意图编排图: `graph/intent_orchestrator_app.py`
- 侦察战术图: `graph/scout_tactical_app.py`
- 语音控制图: `graph/voice_control_app.py`

### 9.2 Intent Handlers
- 救援任务: `intent/handlers/rescue_task_generation.py` (46KB)
- 侦察任务: `intent/handlers/scout_task_generation.py` (3KB)
- 设备控制: `intent/handlers/device_control.py` (9KB)
- 视频分析: `intent/handlers/video_analysis.py` (2KB, ⚠️占位)

### 9.3 API路由
- 主入口: `api/main.py` (792行)
- 救援API: `api/rescue.py`
- 方案规划: `api/plan.py`
- 车载系统: `api/vehicle.py`

### 9.4 Services
- 救援草稿: `services/rescue_draft_service.py`
- 会话管理: `memory/conversation_manager.py`
- 记忆管理: `memory/mem0_facade.py`

### 9.5 文档
- Phase0修复报告: `docs/new_0.1/Phase0-修复完成报告.md`
- State编码规范: `docs/guides/state-coding-standards.md`
- LangGraph最佳实践: `docs/new_0.1/LangGraph最佳实践对比.md`
- 子图体系规划: `docs/new_0.1/子图体系开发规划.md`

---

**报告结束**

**生成方法**: 基于代码库深度分析，10层Linus式思考推导
**可信度**: 高（直接基于代码，不依赖文档）
**待确认事项**: 见第8.1节
