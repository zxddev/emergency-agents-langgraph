# 环境依赖说明（单测 & 本地调试）

## 1. 必须安装的 Python 依赖
| 组件 | 用途 | 安装命令 |
| --- | --- | --- |
| `torch==2.4.1+cpu`、`torchaudio==2.4.1+cpu` | VAD 依赖 Silero 模型，语音链路会在导入阶段加载 | `pip install --index-url https://download.pytorch.org/whl/cpu torch==2.4.1+cpu torchaudio==2.4.1+cpu` |
| `opuslib` | 解码 WebSocket 推流的 Opus 音频 | `pip install opuslib` |
| `langgraph>=1.0.0` | LangGraph 子图、checkpoint 机制 | `pip install langgraph` |
| `qdrant-client>=1.15.0` | Mem0 记忆检索，需要连接 Qdrant | `pip install qdrant-client` |

> 没有这些包，`src/emergency_agents/voice/vad_detector.py`、`graph/rescue_tactical_app.py` 等模块在导入阶段就会抛异常。

## 2. 外部服务依赖
| 服务 | 默认地址 | 作用 | 缺失时的表现 |
| --- | --- | --- | --- |
| Postgres (`POSTGRES_DSN`) | `postgresql://postgres:postgres123@192.168.31.40:5432/emergency_agent` | 事件、任务、快照写入 | Psycopg 抛连接异常，所有 `/intent` 流程失败 |
| Neo4j | `bolt://192.168.31.40:7687` | Mem0 GraphMemory | `Neo4jGraph` 初始化报错，Mem0 搜索报错 |
| Qdrant | `http://192.168.31.40:6333` | Mem0 向量检索 | `qdrant_client` 连接失败，`mem.search` 抛异常 |
| FunASR WebSocket | `wss://192.168.31.40:10096` | 语音链路备用识别 | 健康检查持续失败，日志 `local_asr_unhealthy` |
| TTS 服务 | `http://192.168.31.40:18002/api/tts` | 语音播报 | 健康检查警告，语音回复失败 |
| Java Orchestrator | `http://127.0.0.1:28080/web-api` | 任务/设备指挥通道 | REST 调用报 5xx 或连接拒绝 |

这些服务在 `startup_event` 中同步初始化；缺失任何一项，FastAPI 启动或集成测试会直接失败。

## 3. 测试运行注意事项
1. 先执行上表 pip 安装命令，确保 `.venv` 包齐全。
2. 按照 `config/dev.env` 中的地址启动 Postgres、Neo4j、Qdrant、FunASR、TTS、Java Orchestrator。
3. `pytest` 默认会走真实链路，若未就绪会看到以下典型错误：
   - `psycopg.OperationalError` / `ProgrammingError`：数据库缺失或 JSON 未能适配。
   - `RuntimeError: 意图编排子图未构建`：Startup 阶段失败（缺某服务）。
   - `TimeoutError: timed out during opening handshake`：FunASR WebSocket 不可用。
4. 如需仅验证局部逻辑，可以限定测试路径，例如：`pytest tests/api/test_rescue_draft_api.py`。

## 4. 参考来源
- 代码：`src/emergency_agents/api/main.py` 启动逻辑、`voice/vad_detector.py` 模型加载、`db/dao.py` JSON 持久化。
- 文档：`docs/新业务逻辑md/new_0.1/` 下现有流程设计。
