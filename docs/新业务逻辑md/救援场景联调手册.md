# 救援场景联调手册

本文描述如何从 LangGraph 启动救援任务直至前端收到场景消息，覆盖 AI → Java → 前端 全链路。

## 1. 前置服务

| 模块 | 启动命令/检查点 |
| ---- | ---- |
| LangGraph API | `uvicorn emergency_agents.api.main:app --reload` |
| Java Web-API | `./gradlew bootRun` 或已部署服务，确认 `http://localhost:28080/web-api/health` OK |
| 前端 | `pnpm dev` 指向同一 Java API；登录角色需与推送 `scope` 匹配（默认 commander） |

### 1.1 环境变量

- `WEB_API_BASE_URL`：LangGraph 指向 Java 服务，例如 `http://localhost:28080/web-api`。
- `ORCHESTRATOR_NOTIFY_ENABLED`：需为 `true`（LangGraph 默认 `True`）。
- `PROMPT_LEVEL_COLOR` 等前端常量无须修改，确保 `public/image/event/{eventType}/{eventLevel}.svg` 完整。

## 2. 触发救援任务

使用结构化提示确保 `event_type` 可被识别，并直接请求生成救援方案：

```bash
curl -X POST 'http://127.0.0.1:8008/threads/start?rescue_id=incident-demo-007' \
     -H 'Content-Type: application/json' \
     -d '{
           "raw_report": "请直接生成救援任务。事件类型 secondary_hazard，mission_type rescue，地点 四川省阿坝州茂县南新村（东经103.8507°,北纬31.7003°），待救援人数8人，其中2人骨折，需要破拆、支撑和医疗装备，现场电力中断且持续降雨。",
           "user_id": "commander-01"
         }'
```

### 2.1 正常响应特征
- `status = "awaiting_approval"`
- `proposals[0].requires_approval = true`
- `intent.intent_type = "rescue_task_generation"`

如未携带 `event_type`，LangGraph 会在 `missing_fields` 中提示并保持中断。

## 3. LangGraph → Orchestrator

确认日志 `temp/server.log` 出现：
- `rescue_incident_creating`
- `rescue_incident_created`
- `rescue_scenario_publish_attempt`
- `rescue_scenario_publish_success`

若看到 `orchestrator_client_unconfigured`，说明未配置 Java 服务地址。

## 4. Orchestrator → Java Web-API

Java 日志 `temp/web-api.log`（或控制台）应包含：
- `orchestrator_http_post`（LangGraph HTTP 调用）
- `rescue_scenario_publish_start`
- `rescue_scenario_published`
- STOMP 推送日志 `Broadcasting scenario message category=TASK ...`

如返回 4xx/5xx，`rescue_scenario_publish_failed` 会记入 LangGraph 日志，需检查必填字段（`eventId/location/title/content`）。

## 5. WebSocket & 前端

### 5.1 STOMP 监听

使用浏览器或脚本订阅：

```javascript
const client = new StompJs.Client({ brokerURL: 'ws://localhost:28080/web-api/ws/real-time' });
client.onConnect = () => {
  client.subscribe('/topic/scenario.task.triggered', (msg) => console.log(JSON.parse(msg.body)));
};
client.activate();
```

期望 payload 包含：
- `title`、`content`、`scope`
- `eventType` (1~9) 与 `eventLevel` (1~4)
- `entityIds`（用于地图刷新）
- `extra.module`、`extra.module_next`

### 5.2 前端校验规则
- `ai-broadcast.jsx` 会检查 `eventType`/`eventLevel` 是否为数字。
- 图标路径：`/image/event/{eventType}/{eventLevel}.svg`。
- `scope` 必须包含当前登录角色（如 commander），否则消息被丢弃。
- 若 `data.isPop=true`，将弹出提示并调用 `handleEntityList` 拉取实体。

## 6. 人机审批

LangGraph 默认在 `await` 节点中断，需要人工批准：

```bash
curl -X POST 'http://127.0.0.1:8008/threads/approve?rescue_id=incident-demo-007&user_id=commander-01' \
     -H 'Content-Type: application/json' \
     -d '{"approved_ids":["<proposal_id>"]}'
```

批准后日志应出现 `handler_execution_done`、`commit_memories` 等输出。

## 7. 排查指引

| 阶段 | 日志定位 | 常见问题 |
| ---- | -------- | -------- |
| LangGraph | `temp/server.log` | 未含 `event_type` 或 Orchestrator 未配置 |
| Orchestrator | `temp/server.log` + Java 控制台 | HTTP 4xx/5xx，字段缺失 |
| STOMP | 浏览器控制台 / Node 订阅 | 未推送到对应 topic 或 scope 不匹配 |
| 前端 | `ai-broadcast.jsx`/`EntityWebSocketClient.js` | `eventType`/图标缺失、实体接口失败 |

本手册与《救援场景推送链路》《救援场景测试规范》互补，用于实际调试与问题收敛。MD
