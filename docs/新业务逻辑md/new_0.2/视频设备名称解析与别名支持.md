# 视频设备名称解析与别名支持（严格命中唯一，不猜测）

目标：从用户自然语言的“设备名称”严格、可审计地解析出唯一设备，再进行视频截帧与 GLM‑4V 分析。

## 数据与约束

- 设备规范名 `operational.device.name` 作为业务唯一键（大小写不敏感）。
- 别名表（可选）：`operational.device_alias(alias, device_id)`，用于“口语称呼 → 设备ID”。
- 唯一约束：
  - `CREATE UNIQUE INDEX CONCURRENTLY ux_device_name_lower ON operational.device (lower(name));`
  - `CREATE UNIQUE INDEX CONCURRENTLY ux_device_alias_lower ON operational.device_alias (lower(alias));`

SQL 文件：`sql/operational_device_alias.sql`

## 解析策略（DeviceResolver）

路径：`src/emergency_agents/db/device_resolver.py`

顺序：
1. 名称精确命中（大小写不敏感）
2. 别名精确命中（大小写不敏感）
3. 未命中：抛 `DeviceNotFoundError`，返回建议候选（仅用于提示）
4. 多命中：抛 `AmbiguousDeviceNameError`（数据或别名维护问题）

不做模糊“自动命中”，不降级，不兜底。

## Handler 改造

路径：`src/emergency_agents/intent/handlers/video_analysis.py`

- 使用 `DeviceResolver.resolve_by_name(slots.device_name)` 严格命中唯一设备。
- 流程不变：取流地址 → 截帧 → GLM‑4V 分析 → 返回结构化结果。
- 错误路径：`device_not_found` / `ambiguous_device_name` / `missing_stream_url` / `capture_failed` / `error`。

## DAO 扩展

路径：`src/emergency_agents/db/dao.py`

- `fetch_video_device_by_name_exact(name)`：名称精确命中
- `fetch_video_device_by_alias_exact(alias)`：别名精确命中
- `suggest_devices_by_name_or_alias(query, limit)`：建议候选（仅提示）

## 验收要点

- 唯一命中才能执行业务；多命名/未命名都直接报错（含候选）。
- structlog 覆盖解析开始/命中/未命中/歧义、截帧与 GLM‑4V 外部调用点。
- 与 SITREP 无耦合；视频分析仅在命中“video-analysis”意图时触发。

