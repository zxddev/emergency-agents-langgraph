# 意图澄清与记忆增强设计（最小实现）

目的：
- 缺槽时不猜测，使用结构化澄清（ClarifyRequest）+ 中断/needs_input。
- 记录会话最近设备，在澄清选项中置顶作为默认项，便于真实 AI 决策的多轮连续性。

实现要点：
- SQL：`sql/operational_session_context.sql` 建表 `operational.session_context`。
- 服务：`src/emergency_agents/context/service.py`（强类型、异步）。
- 接入：
  - API `startup` 注入 `ContextService`；
  - `process_intent_core()`：
    - invalid 分支：
      - 设备（严格A）：仅构造 ClarifyRequest（options 置顶最近设备 + default_index=0）。
      - 任务/事件（谨慎B）：若缺失项可由会话上下文全部补齐，则直接补齐并继续处理；否则同样返回 Clarify。
    - 成功后：
      - 写回最近事件（incident_id）。
      - 若本次槽位包含 task_id / task_code，则写回最近任务。
      - video-analysis 成功时已写回最近设备（之前实现）。

策略开关：
- `AUTO_BINDING_POLICY_TASK`: `strict` 或 `cautious`（默认 strict）
- `AUTO_BINDING_POLICY_INCIDENT`: `strict` 或 `cautious`（默认 strict）
  - 设备固定为严格策略（A）。

边界与日志：
- 不自动填槽；仅排序与默认选项，不影响安全性。
- 关键步骤记录结构化日志：`session_context_loaded/saved`、`session_context_lookup_failed`。

兼容性：
- 未创建表时仅失去排序能力，不影响澄清。

测试要点：
- 无候选/单候选/多候选三态：
  - 任务/事件：在 `cautious` 下，单候选自动填，其余走 Clarify。
  - 设备：始终 Clarify；最近设备置顶。
