# 侦察设备能力匹配与缺口提示迭代（2025-11-02）

## 目的
- 保障侦察任务在设备不足时给指挥员清晰反馈，避免“方案生成成功”但无法执行的假象。
- 基于真实数据判断可执行能力，提示最小可行方案与缺口，禁止降级或虚构。

## 代码定位
- 设备能力判定：`src/emergency_agents/graph/scout_tactical_app.py`
  - `_evaluate_device_selection`：归一化传感器 → 匹配设备能力 → 输出 `DeviceSelectionOutcome`。
  - `DeviceSelectionOutcome` / `SelectedDevice` TypedDict 扩展，新增 `{matchedSensors, missingSensors}` 等字段。
  - `device_selection` 节点写入 `device_selection_result`，`selected_devices` 仅保留可执行设备。
  - `prepare_response` → `_build_execution_advice`：将状态写入 `plan.executionAdvice` 并生成响应文本。
  - `prepare_ui_actions_task` 新增 `show_device_advice` 动作，便于前端渲染。
- UI 回传：`src/emergency_agents/intent/handlers/scout_task_generation.py`
  - `_compose_ui_actions` 根据 `executionAdvice` 生成 `show_risk_warning` + `show_toast`，直接提醒指挥员。
- 单元测试：`tests/graph/test_scout_device_selection.py`
  - 覆盖全覆盖/部分/无法执行三种场景。
  - 验证 `missingDisplay` 文本与 UI 动作行为。

## 关键行为
1. **完整覆盖（status=full）**：
   - `usableDevices` 覆盖所有传感器；响应维持原文案。
2. **部分覆盖（status=partial）**：
   - `missingSensors` 列出缺口。
   - 文案：“已生成基础侦察方案，但仍缺少：XXX”。
   - `UIAction`: `show_risk_warning`（level=warning）+ `show_toast`。
3. **完全缺失（status=none）**：
   - 未找到具备任何需求的设备。
   - 响应：“当前无可执行侦察设备，需要尽快补充：XXX”。
   - `UIAction`: `show_risk_warning`（level=danger）+ `show_toast`。

## 影响面
- LangGraph 状态新增 `device_selection_result`。
- 前端需要消费新增动作：`show_device_advice`、`show_toast`。
- Java 中间件保持不变，消息体已有结构化 `ui_actions`。

## 测试建议
```bash
PYTHONPATH=src .venv/bin/pytest tests/graph/test_scout_device_selection.py
```
确保三种分支均覆盖。
