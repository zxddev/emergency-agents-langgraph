# 救援场景测试规范

本文档约束如何验证“AI → Orchestrator → Java → WebSocket → 前端地图”全链路，确保每次测试都可复现。

## 1. 测试目标
- 确认统一意图返回 `hazard_report` 且槽位齐全（含 `event_type`）。
- 验证 `/api/v1/rescue/scenario` 请求成功并在 Java 侧广播 `scenario.task.triggered`。
- 前端收到场景消息后弹窗、刷新模块、渲染地图实体。

## 2. 前置条件
| 项目 | 要求 | 参考 | 
| --- | --- | --- |
| AI 大脑 | FastAPI 运行于 `http://127.0.0.1:8008` | src/emergency_agents/api/main.py |
| Java Web-API | 服务运行于 `http://127.0.0.1:28080/web-api` | emergency-web-api | 
| 前端 | 能访问 `/web-api/ws/real-time` STOMP | emergency-rescue-brain |
| 账号 | 前端登录角色需在 scope 中（默认 `commander`） | RescueScenarioService | 

## 3. 测试输入规范
- 使用 `/threads/start` 创建救援线程：
  ```bash
  curl -X POST 'http://127.0.0.1:8008/threads/start?rescue_id=incident-demo-001' \
       -H 'Content-Type: application/json' \
       -d '{
             "raw_report": "四川省阿坝州茂县南新村（东经103.8507°、北纬31.7003°）今晨发生山体滑坡，8名村民被压在受损民居内，其中2人骨折无法移动，现场电力中断并伴有持续降雨，道路塌方阻断救援车辆通行，请立即组织前突救援力量携带破拆、支撑和医疗装备处置。",
             "user_id": "commander-01"
           }'
  ```
- 必填要素：
| 字段 | 说明 | 
| --- | --- |
| 地点 / 坐标 | LLM 需提取并填入 `slots.location`；无坐标脚本需补充文字位置 | 
| 灾害类型 `event_type` | 文本需明确，如“山体滑坡”→ `secondary_hazard`；LangGraph 旧管线会强制校验此字段 | 
| 人员受困情况 | `casualties`、`injuries` | 
| 危险因素 | 道路、天气、电力等可选，但建议提供，提高方案质量 |

## 4. 测试步骤
### 4.1 AI 阶段
1. 执行上述 `curl` 命令。
2. 检查响应：`intent.intent_type == "hazard_report"` 且 `validation_status == "valid"`。若 `missing_fields` 包含 `event_type`，需修改 raw_report 或手工补提问。
3. 查看日志 `logs/unified_intent_success`（temp/server.log），确认 `prompt_origin` 为 `llm` 或 `fallback`。

### 4.2 Orchestrator API
1. 等待 LangGraph 自动调用 `/api/v1/rescue/scenario`。
2. `tail -f emergency-web-api/web-api.log`，验证出现：
   - `rescue_scenario_publish_start`（含 eventId、title）。
   - `rescue_scenario_published`（额外字段 module_next、victims）。
   - `Broadcasting scenario message`（topic `/topic/scenario.task.triggered`）。
3. 若想复现手动推送，可执行：
   ```bash
   curl -X POST 'http://127.0.0.1:28080/web-api/api/v1/rescue/scenario' \
        -H 'Content-Type: application/json' \
        -d '{
              "eventId": "<Java 事件 UUID>",
              "location": {"longitude": 103.8507, "latitude": 31.7003, "name": "茂县南新村"},
              "title": "茂县南新村救援建议",
              "content": "已生成救援方案...",
              "origin": "AI指挥助手",
              "victimsEstimate": 8,
              "hazards": ["secondary_hazard"],
              "scope": ["commander"],
              "promptLevel": 2
            }'
   ```

### 4.3 WebSocket 验证
1. 使用浏览器 DevTools 或脚本订阅 `/topic/scenario.task.triggered`：
   ```javascript
   const client = new StompJs.Client({ brokerURL: 'ws://127.0.0.1:28080/web-api/ws/real-time' });
   client.onConnect = () => {
     client.subscribe('/topic/scenario.task.triggered', (msg) => console.log(JSON.parse(msg.body)));
   };
   client.activate();
   ```
2. 期望 payload 关键字段：`messageId`、`scope`、`entityIds`、`extra.module`、`extra.coords`、`extra.hazards`。
3. 若无消息，检查：scope 是否包含当前角色；Java 是否成功查到事件实体。

### 4.4 实体拉取与地图
1. 前端日志中 `ai-broadcast.jsx` 应有 `handleScenarioTask` 输出，且调用 `handleEntityList`。
2. 网络面板确认触发 `POST /web-api/api/v1/entities/by-ids`；返回实体中包含 `layerCode`、`geometry`。
3. `handleEntity.js` 根据 `type` 发出 `MAP_EVENTS.ADD_*`；地图应出现震中点、影响范围、规划路线等。

## 5. 验收标准
| 阶段 | 通过条件 |
| --- | --- |
| LLM | `validation_status=valid` 且 `missing_fields=[]`；若出现 `["未知字段"]`，说明事件类型或位置仍未满足校验 |
| Orchestrator | `/api/v1/rescue/scenario` 返回 200，web-api.log 中没有 `rescue_scenario_publish_failed` |
| WebSocket | `/topic/scenario.task.triggered` 收到消息且 `scope` 命中测试账号 |
| 地图 | Mars3D 呈现对应实体，事件弹窗/语音提示正常 |

## 6. 常见问题排查
| 现象 | 排查点 |
| --- | --- |
| 统一意图提示“未知字段” | raw_report 中未包含可映射 `event_type`（hazard_report 需要），或 prompt fallback 未更新（`src/emergency_agents/intent/unified_intent.py`） |
| Java 收到 400/500 | 检查 `RescueScenarioRequest` 是否缺少 `location` 或 `title`，或 `eventId` 不存在 |
| 前端无动画 | scope 不含当前角色；`entityIds` 为空；`/api/v1/entities/by-ids` 返回空；`MAP_EVENTS` 未触发 |
| 弹窗重复/实体叠加 | Java 层 `filterScenarioEntityIds` 未过滤相关大覆盖物；需检查 `EventScenarioService` 逻辑 |

## 7. 相关代码索引
| 模块 | 文件 | 说明 |
| --- | --- | --- |
| 意图校验 | `src/emergency_agents/intent/unified_intent.py:151-165` | hazard_report 必填字段判定 |
| 推送入口 | `src/emergency_agents/intent/handlers/rescue_task_generation.py:640-857` | 任务链路 orchestrator 推送 |
| 方案推送 | `src/emergency_agents/agents/plan_generator.py:250-386` | 审批前的 Orchestrator 调用 |
| HTTP 客户端 | `src/emergency_agents/external/orchestrator_client.py:55-113` | Java API 封装 |
| Java Service | `emergency-web-api/.../RescueScenarioService.java:31-112` | 场景消息构建 |
| 场景广播 | `emergency-web-api/.../EventScenarioService.java:1502-1660,2299-2349` | STOMP 推送逻辑 |
| 前端订阅 | `emergency-rescue-brain/src/services/map/EntityWebSocketClient.js:1-200` | STOMP 客户端 |
| 场景处理 | `emergency-rescue-brain/src/view/ai/ai-broadcast.jsx:266-318` | 弹窗与实体加载 |
| 地图渲染 | `emergency-rescue-brain/src/components/map/handleEntity.js:1-160` | MAP 事件映射 |

> 参考《救援场景推送链路.md》获取更详细的数据流说明。执行测试前请确保日志文件和 WebSocket 客户端均处于监听状态，便于快速定位问题。
