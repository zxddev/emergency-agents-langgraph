# 意图识别改造方案（Provider 架构）

## 1. 架构概览
- 运行时入口：`IntentClassifierRuntime` 在 `src/emergency_agents/intent/classifier.py` 中调用 `providers.factory.build_providers` 构建主提供者与兜底提供者。
- 提供者分层：
  - `LLMIntentProvider`：默认兜底，走统一 JSON Prompt（`src/emergency_agents/intent/providers/llm.py`）。
  - `RasaIntentProvider`：HTTP 调用 `/model/parse`，解析 `intent_ranking`、`entities`（`src/emergency_agents/intent/providers/rasa.py`）。
  - `SetFitIntentProvider`：HTTP 调用 `/predict`，兼容 `proba`、`margin`、`ranking`（`src/emergency_agents/intent/providers/setfit.py`）。
- 阈值控制：`IntentThresholds` 将配置值注入运行时（`src/emergency_agents/intent/providers/base.py`），运行时根据置信度与差值决定 `need_confirm`。

## 2. 配置项映射
| 环境变量 | 作用 | 默认值 | 代码定位 |
| --- | --- | --- | --- |
| `INTENT_PROVIDER` | 主提供者选择：`llm` / `rasa` / `setfit` | `llm` | `src/emergency_agents/config.py:194` |
| `INTENT_RASA_URL` | Rasa Base URL | `None` | `src/emergency_agents/config.py:195` |
| `INTENT_SETFIT_URL` | SetFit 服务 Base URL | `None` | `src/emergency_agents/config.py:196` |
| `INTENT_PROVIDER_TIMEOUT` | HTTP 请求超时（秒） | `1.5` | `src/emergency_agents/config.py:197` |
| `INTENT_CONFIDENCE_THRESHOLD` | 最低置信度阈值 | `0.65` | `src/emergency_agents/config.py:198` |
| `INTENT_MARGIN_THRESHOLD` | Top1-Top2 差值阈值 | `0.20` | `src/emergency_agents/config.py:199` |

## 3. 运行链路
1. `intent_classifier_node` 读取最新用户文本并调用 `IntentClassifierRuntime.__call__`（`src/emergency_agents/intent/classifier.py:57`）。
2. Runtime 调用主提供者 `predict()`，失败则自动回退兜底 LLM（`src/emergency_agents/intent/classifier.py:41`）。
3. Provider 返回 `IntentPrediction`：`intent`、`confidence`、`margin`、`slots`、`ranking` 等。Runtime 根据阈值修正 `need_confirm` 与 `intent_type`。
4. 结果写入 `state['intent']` 与 `state['intent_prediction']` 供后续验证、路由使用。

## 4. Provider 细节
### 4.1 LLMIntentProvider
- 系统提示词强调“仅输出 JSON”，用户消息包含结构化要求。
- 针对战术级救援意图，提示词已强制生成 `coordinates.lat/lng` 与 `situation_summary`（≥15字），否则 Runtime 会返回 `needs_input`。（`src/emergency_agents/intent/providers/llm.py:20-87`）
- 使用 `_clean_json_text` 兼容 Markdown 代码块；`_parse_prediction` 统一字段映射。
- `source` 固定为 `llm`，保证日志可观测。

### 4.2 RasaIntentProvider
- 请求 `POST {base}/model/parse`，自动拼接路径，避免环境配置缺 `/model/parse`。
- `entities` → 槽位字典；`intent_ranking` → 候选列表，差值即 `margin`。
- 失败抛出异常，交由 runtime 兜底。

### 4.3 SetFitIntentProvider
- 请求 `POST {base}/predict`，兼容 `proba`、`confidence`、`margin`、`ranking` 多种字段。
- 若服务未返回 `margin`，使用排行前两名差值估算。
- 默认 `slots` 为空，后续若服务增强可直接写入。

## 5. 日志与监控
- Provider 日志（`structlog`）：`llm_intent_request/response`、`rasa_intent_prediction`、`setfit_intent_prediction`。
- Runtime 日志：`intent_classified` 记录 `intent/confidence/margin/source`。
- 失败日志：`intent_provider_error`，便于 Prometheus 监控 fallback 频次。

## 6. 测试要点
- 单元测试：`pytest tests/intent/test_intent_classifier.py` 确保阈值逻辑与兜底路径正确。
- Provider 集成测试建议：
  - Rasa：使用 `responses` 或 `httpx.MockTransport` 模拟 `/model/parse`。
  - SetFit：模拟 `/predict` 返回不同概率，验证 margin/need_confirm。
  - LLM：构造假客户端返回 JSON 字符串，覆盖 JSON 解析分支。

## 7. 后续拓展
- 在 `IntentPrediction` 中保留 `raw` 字段，便于将来落盘审计。
- OOD 拒答策略可在 Provider 内部追加能量分数或预测集合，`IntentPrediction['need_confirm']` 为直接入口。
- 可在 `IntentClassifierRuntime` 增加缓存，避免同文重复计算。

以上设计与 `src/emergency_agents/intent/providers` 子包代码一一对应，后续变更请同步更新此文档。
