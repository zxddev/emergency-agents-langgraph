# 数据库重构方案（PostgreSQL + PostGIS 假定可用）
目标：去掉冗余表，围绕“事件/任务/实体/能力/障碍/知识资产”六类核心，支持智能体数据需求与审计。仅保留必要枚举与约束，其他使用查找表替代。  
命名建议：新表全部加版本后缀 `_v2`（或 `_v2025`），方便与旧表并存和迁移。

## 1. 核心概念与最小表
- 事件/任务：`incident_v2`（大事件，如一次地震救灾）、`hazard_event_v2`（同一大事件下的子事件/二次灾害/局部险情）、`mission_v2`（行动批次/波次）、`task_v2`（可分配的原子任务）、`task_assignment_v2`（任务-平台绑定）。
- 实体：`geo_entity`（一切地图实体/标绘/目标），`geo_layer`（图层/权限），`obstacle`（障碍/封控/禁飞/水深），`obstacle_raster`（可选栅格引用）。
- 能力与平台：`platform`（车辆/无人机/无人艇/机器狗/人员队伍），`capability_profile`（可版本化能力），`platform_capability`（平台绑定的具体能力数值），`equipment_loadout`（装备/物资/技能）。
- 路径与调度：`route_plan`（任务路径），`route_segment`（段），`route_point`（可选压缩存储），`cost_matrix_cache`（调度使用的成本矩阵快照）。
- 知识资产：`knowledge_asset`（图片/文档/案例），`asset_tag`，`task_asset_link`（任务/事件关联）。
- 审计：`audit_log`（约束命中/豁免/无解原因）。

## 2. 表结构（建议）

> 权限需求：新增用户/角色/权限表，支持到页面功能级别的控制。

> 战时闭环补充：增加侦察/救援优先级 POI、设备状态/遥测、告警、观测归档表。

> 主键选型：如不希望使用 UUID，可统一将所有 `id UUID PRIMARY KEY DEFAULT gen_random_uuid()` 替换为 `id BIGSERIAL PRIMARY KEY`（或 BIGINT 带序列），并将对应外键类型改为 BIGINT；业务编号 `code` 保持 UNIQUE，用于对外标识（推荐 INC/MIS/TSK/RPL 等前缀+日期+序列）。

### 0. 权限与用户（独立于作战数据，推荐单独 schema `iam`，请在实际 DDL 中补充 COMMENT 说明字段）
```sql
-- 建议：CREATE SCHEMA iam; CREATE SCHEMA operational_v2;

CREATE TABLE iam_user_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  username TEXT UNIQUE NOT NULL,
  display_name TEXT,
  email TEXT,
  phone TEXT,
  status TEXT NOT NULL CHECK (status IN ('active','disabled')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 资源可精确到页面功能：resource_type=page/api/component，resource_key=前端路由/按钮标识/API 路径，action=view/edit/execute
CREATE TABLE iam_permission_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  resource_type TEXT NOT NULL CHECK (resource_type IN ('page','api','component')),
  resource_key TEXT NOT NULL,  -- 例如 /missions, /tasks/:id, button:dispatch, api:/v1/tasks/assign
  action TEXT NOT NULL CHECK (action IN ('view','edit','execute')),
  description TEXT,
  UNIQUE (resource_type, resource_key, action)
);

CREATE TABLE iam_role_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT UNIQUE NOT NULL,
  description TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE iam_role_permission_v2 (
  role_id UUID NOT NULL REFERENCES iam_role_v2(id) ON DELETE CASCADE,
  permission_id UUID NOT NULL REFERENCES iam_permission_v2(id) ON DELETE CASCADE,
  PRIMARY KEY (role_id, permission_id)
);

CREATE TABLE iam_user_role_v2 (
  user_id UUID NOT NULL REFERENCES iam_user_v2(id) ON DELETE CASCADE,
  role_id UUID NOT NULL REFERENCES iam_role_v2(id) ON DELETE CASCADE,
  PRIMARY KEY (user_id, role_id)
);
```

### 1bis. 战时补充表（建议，实际 DDL 请为表/字段补充 COMMENT，状态/枚举含义写入 COMMENT 或 CHECK 描述）
```sql
-- 侦察/救援优先级 POI
CREATE TABLE priority_poi_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  incident_id UUID NOT NULL REFERENCES incident_v2(id) ON DELETE CASCADE,
  hazard_event_id UUID REFERENCES hazard_event_v2(id) ON DELETE SET NULL,
  type TEXT NOT NULL,                        -- critical_infra / trapped_cluster / bridge / hospital / ...
  priority INT NOT NULL DEFAULT 3,           -- 1 highest
  geometry geometry(Geometry,4326) NOT NULL,
  time_window TSRANGE,
  source TEXT NOT NULL,                      -- uav/sensor/manual/external
  confidence NUMERIC CHECK (confidence BETWEEN 0 AND 1),
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
COMMENT ON TABLE priority_poi_v2 IS '侦察/救援优先级目标点/区域';
COMMENT ON COLUMN priority_poi_v2.priority IS '1=最高优先';
COMMENT ON COLUMN priority_poi_v2.type IS '目标类别，如桥梁/医院/被困聚集区等';

-- 任务与 POI 关联状态（覆盖/待覆盖）
CREATE TABLE task_poi_link_v2 (
  task_id UUID NOT NULL REFERENCES task_v2(id) ON DELETE CASCADE,
  poi_id UUID NOT NULL REFERENCES priority_poi_v2(id) ON DELETE CASCADE,
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending','in_progress','completed','skipped')),
  metadata JSONB DEFAULT '{}',
  PRIMARY KEY (task_id, poi_id)
);
COMMENT ON TABLE task_poi_link_v2 IS '任务与优先级POI的关联与完成状态';
COMMENT ON COLUMN task_poi_link_v2.status IS 'pending=未覆盖,in_progress=进行中,completed=完成,skipped=跳过';

-- 设备状态/健康日志（必需）
CREATE TABLE platform_status_log_v2 (
  id BIGSERIAL PRIMARY KEY,
  platform_id UUID NOT NULL REFERENCES platform_v2(id) ON DELETE CASCADE,
  status TEXT NOT NULL CHECK (status IN ('available','busy','offline','maintenance')),
  battery_pct NUMERIC,
  fuel_level NUMERIC,
  health TEXT,                      -- ok/warn/fail
  comm_link TEXT,                   -- online/degraded/offline
  location geometry(Point,4326),
  metrics JSONB DEFAULT '{}',       -- 自定义
  ts TIMESTAMPTZ NOT NULL DEFAULT now()
);
COMMENT ON TABLE platform_status_log_v2 IS '设备状态/健康日志';
COMMENT ON COLUMN platform_status_log_v2.status IS 'available=可用,busy=执行中,offline=离线,maintenance=维修';
COMMENT ON COLUMN platform_status_log_v2.health IS 'ok/warn/fail 等自定义健康状态';

-- 可选遥测（如不单独存，可合并到 status_log.metrics）
CREATE TABLE platform_telemetry_v2 (
  id BIGSERIAL PRIMARY KEY,
  platform_id UUID NOT NULL REFERENCES platform_v2(id) ON DELETE CASCADE,
  ts TIMESTAMPTZ NOT NULL DEFAULT now(),
  location geometry(Point,4326),
  speed NUMERIC,
  heading NUMERIC,
  metrics JSONB DEFAULT '{}'
);

-- 告警规则（可选）
CREATE TABLE alert_rule_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  incident_id UUID NOT NULL REFERENCES incident_v2(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  trigger JSONB NOT NULL,           -- {type:'obstacle', obstacle_type:'fire', distance_m:500} 等
  target JSONB NOT NULL,            -- {roles:[], users:[], teams:[], platforms:[]}
  action TEXT NOT NULL CHECK (action IN ('notify','push')),
  enabled BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
COMMENT ON TABLE alert_rule_v2 IS '告警规则，定义触发条件与通知目标';
COMMENT ON COLUMN alert_rule_v2.action IS 'notify/push 等通知方式';

-- 告警事件（实际触发记录）
CREATE TABLE alert_event_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  incident_id UUID NOT NULL REFERENCES incident_v2(id) ON DELETE CASCADE,
  hazard_event_id UUID REFERENCES hazard_event_v2(id) ON DELETE SET NULL,
  rule_id UUID REFERENCES alert_rule_v2(id) ON DELETE SET NULL,
  triggered_by JSONB NOT NULL,      -- 触发源引用，如 obstacle/task/poi
  targets JSONB NOT NULL,           -- 实际通知的用户/角色/队伍/平台
  status TEXT NOT NULL CHECK (status IN ('pending','sent','failed')),
  sent_at TIMESTAMPTZ,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
COMMENT ON TABLE alert_event_v2 IS '告警触发记录';
COMMENT ON COLUMN alert_event_v2.status IS 'pending=待发送,sent=已发送,failed=失败';

-- 观测/情报归档（障碍/优先级的原始证据）
CREATE TABLE observation_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  incident_id UUID NOT NULL REFERENCES incident_v2(id) ON DELETE CASCADE,
  hazard_event_id UUID REFERENCES hazard_event_v2(id) ON DELETE SET NULL,
  source TEXT NOT NULL,             -- uav/sensor/manual/external
  obs_type TEXT NOT NULL,           -- damage/flood/fire/blocked_road/...
  geometry geometry(Geometry,4326) NOT NULL,
  confidence NUMERIC CHECK (confidence BETWEEN 0 AND 1),
  time_window TSRANGE,
  reporter_user_id UUID REFERENCES iam_user_v2(id),            -- 可选：上报人
  reporter_platform_id UUID REFERENCES platform_v2(id) ON DELETE SET NULL, -- 可选：上报设备
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 观测与障碍/POI 溯源（可选桥表）
CREATE TABLE obstacle_observation_v2 (
  obstacle_id UUID NOT NULL REFERENCES obstacle_v2(id) ON DELETE CASCADE,
  observation_id UUID NOT NULL REFERENCES observation_v2(id) ON DELETE CASCADE,
  PRIMARY KEY (obstacle_id, observation_id)
);

CREATE TABLE poi_observation_v2 (
  poi_id UUID NOT NULL REFERENCES priority_poi_v2(id) ON DELETE CASCADE,
  observation_id UUID NOT NULL REFERENCES observation_v2(id) ON DELETE CASCADE,
  PRIMARY KEY (poi_id, observation_id)
);

-- 安全点/疏散集结点（供内外部车队/群众疏散选择）
CREATE TABLE safe_site_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  incident_id UUID NOT NULL REFERENCES incident_v2(id) ON DELETE CASCADE,
  hazard_event_id UUID REFERENCES hazard_event_v2(id) ON DELETE SET NULL,
  name TEXT NOT NULL,
  category TEXT NOT NULL CHECK (category IN ('shelter','assembly','temporary_safe')), -- 避难所/集结点/临时安全点
  geometry geometry(Geometry,4326) NOT NULL,
  capacity INT,
  suitability NUMERIC,                      -- 评分，用于推荐
  status TEXT NOT NULL DEFAULT 'available' CHECK (status IN ('available','limited','full','closed')),
  source TEXT NOT NULL,                     -- upper_command/manual/ai/field
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
COMMENT ON TABLE safe_site_v2 IS '安全/疏散/集结点';
COMMENT ON COLUMN safe_site_v2.status IS 'available=可用,limited=受限,full=满员,closed=关闭';

-- 任务/车队/队伍与安全点的推荐或选择记录（可选）
CREATE TABLE safe_site_selection_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  mission_id UUID NOT NULL REFERENCES mission_v2(id) ON DELETE CASCADE,
  task_id UUID REFERENCES task_v2(id) ON DELETE SET NULL,
  platform_id UUID REFERENCES platform_v2(id) ON DELETE SET NULL,
  rescue_team_id UUID REFERENCES rescue_team_v2(id) ON DELETE SET NULL,
  safe_site_id UUID NOT NULL REFERENCES safe_site_v2(id) ON DELETE CASCADE,
  selection_reason TEXT,
  status TEXT NOT NULL DEFAULT 'proposed' CHECK (status IN ('proposed','accepted','rejected')),
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
COMMENT ON TABLE safe_site_selection_v2 IS '任务/平台/队伍与安全点的推荐/选择记录';
COMMENT ON COLUMN safe_site_selection_v2.status IS 'proposed=推荐,accepted=接受,rejected=拒绝';
```

### 1ter. 态势总览/快照（建议）
```sql
-- 实时/周期汇总的态势快照，便于上报与历史回溯
CREATE TABLE situation_snapshot_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  incident_id UUID NOT NULL REFERENCES incident_v2(id) ON DELETE CASCADE,
  hazard_event_id UUID REFERENCES hazard_event_v2(id) ON DELETE SET NULL,
  generated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  summary JSONB NOT NULL,   -- 聚合结果：关键障碍、优先级POI、任务进度、平台状态摘要等
  source TEXT NOT NULL,     -- system/ai/manual
  metadata JSONB DEFAULT '{}'
);
```

### 2.1 事件/任务
```sql
CREATE TABLE incident_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),         -- 如需去 UUID，可改 BIGSERIAL
  code TEXT NOT NULL UNIQUE,                             -- 业务编号，如 INC20250214-0001
  name TEXT NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('active','closed','archived')),
  source TEXT NOT NULL,                                  -- 来源：upper_command / manual / uav / sensor / external_agency ...
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  metadata JSONB DEFAULT '{}'
);

-- 同一大事件下的子事件/二次灾害
CREATE TABLE hazard_event_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),         -- 可改 BIGSERIAL
  code TEXT NOT NULL UNIQUE,                             -- HEV20250214-0001
  incident_id UUID NOT NULL REFERENCES incident_v2(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  hazard_type TEXT,                        -- flood/fire/aftershock/…
  status TEXT NOT NULL CHECK (status IN ('active','monitoring','resolved','archived')),
  time_window TSRANGE,
  geometry geometry(Geometry,4326),       -- 影响范围
  source TEXT NOT NULL,                    -- uav/sensor/manual/upper_command/external
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE mission_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),         -- 可改 BIGSERIAL
  code TEXT NOT NULL UNIQUE,                             -- MIS20250214-0001
  incident_id UUID NOT NULL REFERENCES incident_v2(id) ON DELETE CASCADE,
  hazard_event_id UUID REFERENCES hazard_event_v2(id) ON DELETE SET NULL, -- 可选：挂载到具体子事件
  name TEXT NOT NULL,
  phase TEXT NOT NULL CHECK (phase IN ('preparation','transit','recon','rescue','evaluation')),
  status TEXT NOT NULL CHECK (status IN ('planning','in_progress','completed','failed','cancelled')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  metadata JSONB DEFAULT '{}'
);

CREATE TABLE task_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),         -- 可改 BIGSERIAL
  code TEXT NOT NULL UNIQUE,                             -- TSK20250214-0001
  mission_id UUID NOT NULL REFERENCES mission_v2(id) ON DELETE CASCADE,
  hazard_event_id UUID REFERENCES hazard_event_v2(id) ON DELETE SET NULL,
  type TEXT NOT NULL,                          -- uav_recon/material_transport/rescue/...
  priority INT NOT NULL DEFAULT 3,             -- 1 highest
  time_window TSRANGE,                         -- 任务时间窗
  location geometry(Point, 4326),             -- 可选中心点
  area geometry(Geometry, 4326),              -- 目标区域（多边形/线等），适用于侦察/搜救范围
  status TEXT NOT NULL CHECK (status IN ('pending','in_progress','completed','failed','cancelled')),
  demand JSONB NOT NULL DEFAULT '{}'::jsonb,   -- 物资/装备/技能需求
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
COMMENT ON TABLE task_v2 IS '任务表（最小可分配单元）';
COMMENT ON COLUMN task_v2.type IS '任务类型：uav_recon/material_transport/rescue/...';
COMMENT ON COLUMN task_v2.priority IS '优先级，1最高';
COMMENT ON COLUMN task_v2.status IS 'pending=待执行,in_progress=执行中,completed=完成,failed=失败,cancelled=取消';
COMMENT ON COLUMN task_v2.demand IS '物资/装备/技能需求，JSON';
COMMENT ON COLUMN task_v2.area IS '目标区域，多边形/线';
COMMENT ON COLUMN task_v2.time_window IS '任务时间窗（tsrange）';
COMMENT ON COLUMN task_v2.code IS '任务业务编号，如 TSK20250214-0001';

CREATE TABLE task_assignment_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id UUID NOT NULL REFERENCES task_v2(id) ON DELETE CASCADE,
  platform_id UUID REFERENCES platform_v2(id),          -- 内部执行时填写
  rescue_team_id UUID REFERENCES rescue_team_v2(id),    -- 外部队伍时填写
  status TEXT NOT NULL CHECK (status IN ('assigned','accepted','rejected','completed','failed')),
  eta_hours NUMERIC,
  route_plan_id UUID REFERENCES route_plan_v2(id),
  cost NUMERIC,
  executor_type TEXT NOT NULL CHECK (executor_type IN ('internal_platform','external_team')), -- 内部平台 vs 外部队伍
  responsible_user_id UUID REFERENCES iam_user_v2(id), -- 负责人（人），用于背书/审核
  approval_status TEXT NOT NULL DEFAULT 'pending' CHECK (approval_status IN ('pending','approved','rejected')),
  approved_by UUID REFERENCES iam_user_v2(id),
  approved_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  -- 约束：内部必须有 platform_id，外部必须有 rescue_team_id，且互斥
  CHECK (
    (executor_type='internal_platform' AND platform_id IS NOT NULL AND rescue_team_id IS NULL)
    OR
    (executor_type='external_team' AND rescue_team_id IS NOT NULL AND platform_id IS NULL)
  )
);
-- 唯一性（避免 NULL 失效）：内部/外部分别唯一
CREATE UNIQUE INDEX ux_task_assign_internal ON task_assignment_v2(task_id, platform_id) WHERE platform_id IS NOT NULL;
CREATE UNIQUE INDEX ux_task_assign_external ON task_assignment_v2(task_id, rescue_team_id) WHERE rescue_team_id IS NOT NULL;

-- COMMENT 示例（其他字段比照补充）
COMMENT ON TABLE task_assignment_v2 IS '任务指派，内外部执行二选一，带审批/负责人';
COMMENT ON COLUMN task_assignment_v2.status IS 'assigned=已指派,accepted=接受, rejected=拒绝, completed=完成, failed=失败';
COMMENT ON COLUMN task_assignment_v2.approval_status IS 'pending=待审, approved=通过, rejected=拒绝';
```

### 2.2 实体/障碍/图层
```sql
CREATE TABLE geo_layer_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  category TEXT NOT NULL CHECK (category IN ('system','manual','hybrid')),
  access_scope TEXT NOT NULL CHECK (access_scope IN ('view','manage')),
  metadata JSONB DEFAULT '{}'
);

CREATE TABLE geo_entity_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  layer_id UUID REFERENCES geo_layer_v2(id) ON DELETE SET NULL,
  incident_id UUID REFERENCES incident_v2(id) ON DELETE CASCADE,
  type TEXT NOT NULL,                          -- 如: rescue_target / friendly_force / command_post / planned_route / markup_point ...
geometry geometry(Geometry, 4326) NOT NULL, -- point/line/polygon/circle as geometry
  properties JSONB DEFAULT '{}',
  source TEXT NOT NULL CHECK (source IN ('system','manual')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE obstacle_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  incident_id UUID NOT NULL REFERENCES incident_v2(id) ON DELETE CASCADE,
  hazard_event_id UUID REFERENCES hazard_event_v2(id) ON DELETE SET NULL,
  type TEXT NOT NULL,                          -- road_blockage / flood / fire / no_fly / no_sail / hazard_zone ...
  hardness TEXT NOT NULL CHECK (hardness IN ('hard','soft')),
  time_window TSRANGE,
  geometry geometry(Geometry, 4326) NOT NULL,
  severity TEXT CHECK (severity IN ('low','medium','high','critical')),
  source TEXT NOT NULL,                        -- sensor / uav / manual / external
  confidence NUMERIC CHECK (confidence BETWEEN 0 AND 1),
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 可选：栅格障碍引用（外部文件路径/tiles）
CREATE TABLE obstacle_raster_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  obstacle_id UUID NOT NULL REFERENCES obstacle_v2(id) ON DELETE CASCADE,
  uri TEXT NOT NULL,         -- raster 路径或 tileset id
  band_info JSONB DEFAULT '{}'
);
```

### 2.3 平台/能力/装备
```sql
CREATE TABLE capability_profile_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  kind TEXT NOT NULL CHECK (kind IN ('ground','uav','usv','robot_dog','personnel')),
  version TEXT NOT NULL DEFAULT 'v1',
  specs JSONB NOT NULL,  -- {width_m, weight_kg, axle_load, turn_radius_m, max_slope_deg, max_side_slope_deg, wading_depth_m, endurance_min, airtime_min, wind_resistance, payload_kg, skills:[], equipment:[] ...}
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE platform_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  platform_type TEXT NOT NULL CHECK (platform_type IN ('vehicle','uav','usv','robot_dog','team')),
  status TEXT NOT NULL CHECK (status IN ('available','busy','offline','maintenance')),
  capability_profile_id UUID REFERENCES capability_profile_v2(id),
  home_location geometry(Point,4326),
  org_unit TEXT,                          -- 所属单位/队伍名称
  plate_no TEXT,                          -- 车辆牌号（车辆适用）
  serial_no TEXT,                         -- 设备序列号（无人机/艇/机器人）
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 绑定能力并允许覆盖部分字段
CREATE TABLE platform_capability_v2 (
  platform_id UUID PRIMARY KEY REFERENCES platform_v2(id) ON DELETE CASCADE,
  overrides JSONB DEFAULT '{}',   -- 覆盖 capability_profile.specs 中部分字段
  effective_profile JSONB,        -- 冗余存储合并后的能力，便于查询
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE equipment_loadout_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  platform_id UUID NOT NULL REFERENCES platform_v2(id) ON DELETE CASCADE,
  item_id TEXT NOT NULL,          -- 装备/物资/技能标识
  qty NUMERIC,
  metadata JSONB DEFAULT '{}',
  UNIQUE (platform_id, item_id)
);

-- 可选：队伍建模（人员/排连/救援队）
CREATE TABLE rescue_team_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  org TEXT,
  home_base geometry(Point,4326),
  contact TEXT,
  status TEXT NOT NULL CHECK (status IN ('available','busy','offline')),
  capability_profile_id UUID REFERENCES capability_profile_v2(id),
  location geometry(Point,4326),             -- 实时/最近位置（可选更新）
  metadata JSONB DEFAULT '{}',                -- 可包含设备列表、特长标签
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 队伍成员与平台关系
CREATE TABLE team_member_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  team_id UUID NOT NULL REFERENCES rescue_team_v2(id) ON DELETE CASCADE,
  platform_id UUID REFERENCES platform_v2(id) ON DELETE SET NULL,  -- 若成员是一台设备/车辆
  person_name TEXT,
  role TEXT,                       -- 驾驶/指挥/侦察/医护 等
  contact TEXT,
  metadata JSONB DEFAULT '{}'
);
-- 唯一约束：同一队伍同一平台/成员不重复
CREATE UNIQUE INDEX ux_team_member_platform ON team_member_v2(team_id, platform_id) WHERE platform_id IS NOT NULL;
CREATE UNIQUE INDEX ux_team_member_person ON team_member_v2(team_id, person_name, role) WHERE person_name IS NOT NULL;

-- 外部队伍的设备/能力声明（便于 App 录入，AI 选择）
CREATE TABLE team_platform_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  team_id UUID NOT NULL REFERENCES rescue_team_v2(id) ON DELETE CASCADE,
  platform_id UUID REFERENCES platform_v2(id),   -- 可选挂现有平台库
  name TEXT,                                    -- 如果未挂平台，可直接填名称
  capability_profile_id UUID REFERENCES capability_profile_v2(id),
  skills TEXT[],                                -- 特长标签
  contact TEXT,
  metadata JSONB DEFAULT '{}'
);
-- 唯一约束：避免重复登记
CREATE UNIQUE INDEX ux_team_platform_platform ON team_platform_v2(team_id, platform_id) WHERE platform_id IS NOT NULL;
CREATE UNIQUE INDEX ux_team_platform_name ON team_platform_v2(team_id, name) WHERE name IS NOT NULL;

-- 队伍轨迹/位置历史（可选）
CREATE TABLE team_location_log_v2 (
  id BIGSERIAL PRIMARY KEY,
  team_id UUID NOT NULL REFERENCES rescue_team_v2(id) ON DELETE CASCADE,
  ts TIMESTAMPTZ NOT NULL DEFAULT now(),
  location geometry(Point,4326),
  metadata JSONB DEFAULT '{}'
);
```

### 2.4 路径与调度
```sql
CREATE TABLE route_plan_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code TEXT UNIQUE,                                      -- 业务编号，如 RPL20250214-0001
  mission_id UUID NOT NULL REFERENCES mission_v2(id) ON DELETE CASCADE,
  platform_id UUID REFERENCES platform_v2(id),          -- 内部平台时填写
  rescue_team_id UUID REFERENCES rescue_team_v2(id),    -- 外部队伍时填写
  task_id UUID REFERENCES task_v2(id),
  status TEXT NOT NULL CHECK (status IN ('draft','active','completed','failed','cancelled')),
  cost NUMERIC,
  risk JSONB DEFAULT '{}',          -- 命中的硬/软、豁免
  safe_site_id UUID REFERENCES safe_site_v2(id),        -- 若为疏散/集结路线，可关联安全点
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
  -- 约束：内部/外部二选一
  ,CHECK (
    (platform_id IS NOT NULL AND rescue_team_id IS NULL)
    OR
    (platform_id IS NULL AND rescue_team_id IS NOT NULL)
  )
);

-- 示例 COMMENT（落地时为所有表/字段补充类似注释）
COMMENT ON TABLE route_plan_v2 IS '路径规划主表，挂内/外部执行对象，可关联安全点';
COMMENT ON COLUMN route_plan_v2.status IS 'draft=草稿,active=下发执行,completed=完成,failed=失败,cancelled=取消';
COMMENT ON COLUMN route_plan_v2.safe_site_id IS '关联安全/疏散点（safe_site_v2）';

-- 若需要限制同一任务/执行主体仅一条主路线，可开启部分唯一索引（按需启用）
-- CREATE UNIQUE INDEX ux_route_plan_internal ON route_plan_v2(task_id, platform_id) WHERE platform_id IS NOT NULL;
-- CREATE UNIQUE INDEX ux_route_plan_external ON route_plan_v2(task_id, rescue_team_id) WHERE rescue_team_id IS NOT NULL;

-- 路径候选（支持多条方案，供指挥员选择）
CREATE TABLE route_candidate_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  route_plan_id UUID NOT NULL REFERENCES route_plan_v2(id) ON DELETE CASCADE,
  rank INT NOT NULL,                       -- 1=最优，其次依次
  status TEXT NOT NULL DEFAULT 'proposed' CHECK (status IN ('proposed','selected','rejected')),
  cost NUMERIC,
  risk JSONB DEFAULT '{}',
  geometry geometry(LineString,4326),     -- 可选整体线；也可引用 segment
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE (route_plan_id, rank)
);

CREATE TABLE route_segment_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  route_plan_id UUID NOT NULL REFERENCES route_plan_v2(id) ON DELETE CASCADE,
  seq INT NOT NULL,
  start_point geometry(Point,4326),
  end_point geometry(Point,4326),
  geometry geometry(LineString,4326),   -- 可选；若点集太大可用外部存储
  channel TEXT NOT NULL DEFAULT 'ground' CHECK (channel IN ('ground','air','water','foot')),
  distance_km NUMERIC,
  eta_hours NUMERIC,
  metrics JSONB DEFAULT '{}'
);

-- 如需存点集：可压缩存储或外部对象存储，这里提供基表
CREATE TABLE route_point_v2 (
  id BIGSERIAL PRIMARY KEY,
  segment_id UUID NOT NULL REFERENCES route_segment_v2(id) ON DELETE CASCADE,
  seq INT NOT NULL,
  pt geometry(Point,4326)
);

-- 调度成本矩阵缓存（调度智能体与路径智能体的接口）
CREATE TABLE cost_matrix_cache_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  mission_id UUID NOT NULL REFERENCES mission_v2(id) ON DELETE CASCADE,
  computed_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  matrix JSONB NOT NULL,          -- { (platform_id, task_id): cost or INF }
  metadata JSONB DEFAULT '{}'
);

-- 可选：稀疏成本边表，便于审计/过滤原因
CREATE TABLE cost_matrix_edge_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  cache_id UUID NOT NULL REFERENCES cost_matrix_cache_v2(id) ON DELETE CASCADE,
  platform_id UUID NOT NULL REFERENCES platform_v2(id),
  task_id UUID NOT NULL REFERENCES task_v2(id),
  cost NUMERIC,
  feasible BOOLEAN NOT NULL DEFAULT true,
  reason TEXT,                     -- 不可行/高成本原因
  metadata JSONB DEFAULT '{}',
  UNIQUE (cache_id, platform_id, task_id)
);
```

### 2.5 知识资产
```sql
CREATE TABLE knowledge_asset_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT NOT NULL,
  kind TEXT NOT NULL CHECK (kind IN ('image','document','case','spec')),
  uri TEXT NOT NULL,              -- 文件/对象存储路径
  tags TEXT[] DEFAULT '{}',
  metadata JSONB DEFAULT '{}',    -- EXIF、ocr、摘要等
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE task_asset_link_v2 (
  task_id UUID NOT NULL REFERENCES task_v2(id) ON DELETE CASCADE,
  asset_id UUID NOT NULL REFERENCES knowledge_asset_v2(id) ON DELETE CASCADE,
  PRIMARY KEY (task_id, asset_id)
);

-- 通用资产关联（如需挂到 incident/hazard_event/platform/obstacle/observation 等）
CREATE TABLE asset_link_v2 (
  asset_id UUID NOT NULL REFERENCES knowledge_asset_v2(id) ON DELETE CASCADE,
  entity_type TEXT NOT NULL,     -- 'task','incident','hazard_event','platform','obstacle','observation',...
  entity_id UUID NOT NULL,
  role TEXT,                     -- 'evidence','spec','after_action_report',...
  metadata JSONB DEFAULT '{}',
  PRIMARY KEY (asset_id, entity_type, entity_id)
);
```

### 2.6 审计
```sql
CREATE TABLE audit_log_v2 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  mission_id UUID REFERENCES mission_v2(id) ON DELETE CASCADE,
  task_id UUID REFERENCES task_v2(id) ON DELETE SET NULL,
  platform_id UUID REFERENCES platform_v2(id) ON DELETE SET NULL,
  route_plan_id UUID REFERENCES route_plan_v2(id) ON DELETE SET NULL,
  category TEXT NOT NULL,           -- constraint_hit / waiver / no_solution / replanning
  detail JSONB NOT NULL,            -- {constraint: 'no_fly', geometry: ..., reason:..., waiver_by:...}
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

## 3. 迁移策略
- 新表统一使用 `_v2` 后缀，与旧表并存，便于双写迁移。
- 仅保留：事件/任务（必要字段）、设备/车辆（迁入 platform_v2/capability_profile_v2）、实体/标绘（迁入 geo_entity_v2/geo_layer_v2）。其余旧表弃用或做视图兼容。
- 先建新表并双写：新接口写入新表，旧接口读旧表直至前端/服务切换。
- 数据迁移：
  - 旧车辆/设备 → platform + capability_profile（手工映射字段）。
  - 旧实体/标绘/障碍 → geo_entity + obstacle（需统一 type 与 hardness）。
  - 旧任务/task → mission/task；保留 status/时间窗/位置。
  - 如需兼容旧 ENUM，改为 TEXT + CHECK 或查找表，减少变更成本。

## 4. 索引建议
- `obstacle`：GIST(geometry)，GIN(metadata)，btree(time_window)。
- `geo_entity`：GIST(geometry)，btree(incident_id)。
- `task`：btree(mission_id, status, priority)，btree(time_window)。
- `task_assignment`：btree(task_id, platform_id)。
- `platform`：btree(status, platform_type)。
- `route_segment`：btree(route_plan_id, seq)；如存 geometry 则 GIST。

## 5. 对智能体的支撑关系
- 感知与障碍标注 → `obstacle_v2`/`obstacle_raster_v2`/`geo_entity_v2`；source/confidence/time_window 满足质量控制。
- 能力建模 → `capability_profile_v2`/`platform_v2`/`platform_capability_v2`/`equipment_loadout_v2`。
- 路径规划 → 读 `obstacle_v2`、`platform_capability_v2`，写 `route_plan_v2/route_segment_v2/route_point_v2`，输出风险写 `audit_log_v2`。
- 调度 → 读 `platform_v2`、`task_v2`、`cost_matrix_cache_v2`，写 `task_assignment_v2`，引用 `route_plan_v2`。
- 评估与解释 → 读 `route_plan_v2`、`audit_log_v2`、`knowledge_asset_v2`，输出可视化引用。

## 6. 清理与弃用
- 弃用大量旧 ENUM（entity_type_enum*、mission_status* 等），统一 TEXT+CHECK。
- 弃用旧 car_device_select/car_supply_select 等“选择”表，改为 `equipment_loadout`。
- 聊天/对话类表（conversations/messages）若需保留，放到独立 schema，不与作战数据混用。
