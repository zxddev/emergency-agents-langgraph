from __future__ import annotations

import json
from typing import Any, Dict, Iterable, List


def _format_section(title: str, lines: Iterable[str]) -> str:
    """格式化章节内容"""
    content = "\n".join(line for line in lines if line)
    if not content.strip():
        return ""
    return f"{title}\n{content.strip()}\n"


def build_post_rescue_assessment_prompt(
    payload: Dict[str, Any],
    reference_materials: List[str] | None = None
) -> str:
    """构造救援评估报告提示词（事后总结复盘）。

    Args:
        payload: 已序列化的救援完整数据，包含过程和结果
        reference_materials: 外部参考资料（评估标准、历史案例对比、优秀报告范例）

    Returns:
        供大模型使用的完整提示词
    """

    json_blob = json.dumps(payload, ensure_ascii=False, indent=2)

    header = (
        "你现在是【应急管理评估专家】，受委托撰写一份专业的【地震救援工作总结评估报告】。\n"
        "本报告将提交给应急管理部门，用于总结经验、查找不足、改进应急响应能力。\n\n"
        "核心要求：\n"
        "1. **客观性**：严格基于提供的数据撰写，所有时间、数字、名称必须与原始数据完全一致，不得虚构或夸大。\n"
        "2. **量化评估**：对关键指标进行量化分析，如响应及时性、救援成功率、资源利用效率等。\n"
        "3. **对比分析**：将本次救援与预案要求、历史案例、国际标准进行对比，指出差距和进步。\n"
        "4. **问题导向**：重点分析存在的问题和短板，不回避矛盾，不粉饰太平。\n"
        "5. **改进建议**：提出具体、可操作、可落地的改进建议，避免空泛表述。\n"
        "6. **引用来源**：在引用评估标准、历史案例、权威数据时，必须标注来源。\n"
        "7. **专业表述**：使用应急管理领域的专业术语，避免口语化和模糊措辞。\n"
        "8. **数据缺失处理**：若某些关键数据缺失，需明确指出【数据缺失】，并说明对评估的影响。\n"
    )

    template = _format_section(
        "报告必须包含的章节：",
        [
            "# 地震救援工作总结评估报告",
            "",
            "## 一、灾害基本情况",
            "包含：灾害名称、发生时间、地点、规模、影响范围、最终伤亡统计、经济损失。",
            "重点：用简洁的语言概述灾害的基本面貌，为后续分析提供背景。",
            "",
            "## 二、应急响应过程",
            "包含：响应级别启动、指挥机构设立、关键时间节点（接报→启动→到达→结束）。",
            "重点：",
            "- 计算响应及时性：从接报到启动响应的时间、首支队伍到达时间。",
            "- 对比预案要求：是否符合应急预案规定的响应时限。",
            "- 分析关键决策节点：哪些决策是关键的、是否及时、是否正确。",
            "",
            "## 三、救援力量投入与调度",
            "包含：各类救援力量清单（类型、单位、人数、装备、到位时间、承担任务）。",
            "重点：",
            "- 力量规模：是否满足救援需求。",
            "- 到位及时性：各支队伍到位时间是否合理。",
            "- 任务分工：是否科学合理、有无重叠或遗漏。",
            "- 装备配置：结合外部参考资料，评估装备配置的合理性。",
            "",
            "## 四、救援成效评估",
            "包含：人员搜救、转移安置、医疗救治、物资发放、基础设施抢通的统计数据。",
            "重点（必须量化）：",
            "- **救援成功率** = 成功救出生还者 / 累计搜救人数",
            "- **救援效率** = 累计搜救人数 / （投入人员 × 救援天数）",
            "- **资源利用率**：人均救援人数、单位资金救助人数等。",
            "- **与目标对比**：实际成效与预期目标的对比。",
            "",
            "## 五、协同配合与信息共享",
            "包含：政府部门、军地、社会力量、跨区域的协同情况。",
            "重点：",
            "- 协同机制运行情况：是否顺畅、有无障碍。",
            "- 信息共享效率：信息传递是否及时、准确。",
            "- 指挥体系运行：统一指挥是否有效。",
            "",
            "## 六、存在的问题与不足",
            "包含：交通、通信、装备、人员、天气、次生灾害、协调等方面的困难。",
            "重点（问题导向）：",
            "- **不回避矛盾**：客观列出所有重大问题。",
            "- **分析根本原因**：问题是偶然的还是系统性的。",
            "- **量化影响**：问题对救援工作的影响程度（如延误多少小时、影响多少人）。",
            "- **责任归属**：是预案问题、执行问题、还是不可抗力。",
            "",
            "## 七、经验总结与改进建议",
            "包含：",
            "### 7.1 成功经验与可复制做法",
            "- 列出本次救援中的创新做法、成功经验。",
            "- 分析为什么成功、是否可复制推广。",
            "",
            "### 7.2 改进建议（具体、可操作）",
            "- **预案修订建议**：哪些预案内容需要修订、如何修订。",
            "- **能力建设建议**：装备配置、队伍建设、培训演练等。",
            "- **机制完善建议**：协调机制、信息共享机制、资金拨付机制等。",
            "- **保障措施建议**：交通、通信、物资保障等。",
            "",
            "### 7.3 需要上级部门协调的事项",
            "- 跨部门协调机制、跨区域协作机制等需要上级推动的事项。",
            "",
            "---",
            "**落款**：【应急管理评估专家组】",
            "**日期**：救援结束时间",
        ],
    )

    guidance = _format_section(
        "完整救援数据（必须严格遵循）：",
        [f"```json\n{json_blob}\n```"],
    )

    ref_section = ""
    if reference_materials:
        ref_content = "\n\n".join(reference_materials)
        ref_section = _format_section(
            "权威参考资料（用于对比分析和标准引用）：",
            [ref_content],
        )

    quantitative_analysis = _format_section(
        "量化指标计算要求：",
        [
            "1. **响应及时性**：",
            "   - 接报到启动响应时间 = 响应启动时间 - 灾害发生时间",
            "   - 接报到首支队伍到达时间 = 第一支队伍到位时间 - 灾害发生时间",
            "   - 与预案要求对比：国家地震应急预案规定特别重大地震需在X小时内启动响应。",
            "",
            "2. **救援成功率**：",
            "   - 救援成功率 = 成功救出生还者人数 / 累计搜救人数 × 100%",
            "   - 与国际标准对比：地震救援黄金72小时内成功率应达到X%。",
            "",
            "3. **资源利用效率**：",
            "   - 人均救援人数 = 累计搜救人数 / 投入救援人员总数",
            "   - 单位时间救援效率 = 累计搜救人数 / 救援持续天数",
            "   - 资金使用效率 = 救助人数 / 投入资金总额",
            "",
            "4. **协同配合度**（定性分析转定量）：",
            "   - 根据协同情况描述，评估为：优秀（90-100分）、良好（75-89分）、合格（60-74分）、不合格（<60分）",
        ],
    )

    writing_rules = _format_section(
        "写作规范：",
        [
            "- **数据精确**：所有数字必须与原始数据一致，不得四舍五入或估算（除非明确标注为估算）。",
            "- **逻辑严密**：各章节之间有逻辑关联，避免前后矛盾。",
            "- **重点突出**：用**加粗**或**表格**突出关键指标和重要结论。",
            "- **对比分析**：关键指标必须与预案要求、历史案例、国际标准对比，指出差距。",
            "- **问题导向**：第六章【存在的问题】必须充分展开，不能一笔带过。",
            "- **建议可行**：第七章改进建议必须具体，避免【加强领导】【提高认识】等空话。",
            "- **引用规范**：引用外部资料时使用【依据XX标准】【参考XX案例】格式。",
            "- **表格使用**：复杂数据建议使用Markdown表格呈现，便于对比。",
        ],
    )

    comparison_requirements = _format_section(
        "对比分析要求（关键）：",
        [
            "1. **与预案要求对比**：",
            "   - 实际响应时间 vs 预案规定时限",
            "   - 实际投入力量 vs 预案规定规模",
            "   - 实际救援效果 vs 预案预期目标",
            "",
            "2. **与历史案例对比**（如有外部参考资料）：",
            "   - 与相似规模地震救援的对比（如汶川、雅安、九寨沟）",
            "   - 响应速度对比",
            "   - 救援成功率对比",
            "   - 资源投入规模对比",
            "",
            "3. **与国际标准对比**（如有外部参考资料）：",
            "   - 联合国INSARAG国际搜救标准",
            "   - 黄金72小时救援窗口期利用情况",
            "",
            "4. **进步与差距分析**：",
            "   - 与本地区历史救援相比的进步",
            "   - 与国内外先进水平的差距",
        ],
    )

    return "\n".join(
        part for part in (
            header,
            template,
            guidance,
            ref_section,
            quantitative_analysis,
            comparison_requirements,
            writing_rules
        ) if part
    )
