# **“准备阶段（应急响应与准备）”需求规格说明书 V1.0**

> 适用范围：AI应急大脑与全空间智能车辆系统
> 阶段边界：从“上级事件通报抵达指挥车”到“指挥员下达出发命令”闭环完成

---

## 1. 背景与目标

* **背景**：突发事件（例：某地区地震）发生后，存在断网断路、通信受限、态势不明等不确定性，需要在车辆尚未出动前完成“信息统一、装备编组、任务下发、准备确认”的快速闭环。
* **阶段目标（10–15 分钟内完成）**

  1. 事件强提醒上屏并留痕；2) 文本灾情结构化入库并“上图”；3) 基于灾型与地域快速生成“车-装-物-无人装备”建议包；4) 车组可按专业二次调整并提交；5) 指挥端汇总差异与风险校验；6) 所有车辆准备完成后一次性下达“出发命令”。

> 能力基线引用项目既有“模型矩阵/智能体/功能点”作为本阶段能力来源（如装备/物资智能推荐、路线预规划、ASR/TTS、通信保障等）。

---

## 2. 术语与角色

* **术语**

  * **高闪一直播报**：强制高优先级视觉（闪烁/标红）与听觉（TTS）连续播报，直至被具备权限的操作员确认并留痕。
  * **一张图**：多源实体（事件、风险、要素、资源、任务）在同一三维底图上的统一表达。
* **角色与权限**

  * **上级指挥大厅**：事件下发、约束指令、复核日志；可撤回/更新事件。
  * **指挥车指挥员**：准备阶段的主责任人；可确认事件、下发任务包、签发出发命令。
  * **各车辆车长/装载官**：接收任务包、编辑本车载具与物资、提交变更。
  * **AI应急大脑**：态势解析、风险评估、推荐计算、差异对账、规则校验。
  * **权限**：遵循分级分域与审计（见 9.5），支持离线授权缓存。

---

## 3. 业务流程（泳道化描述）

1. **事件通报到达（上级→指挥车）**
   → 客户端触发“高闪一直播报”+ TTS，禁用静音 10 秒内不可关闭；需“指挥员账户”手签确认。
2. **事件初始态势结构化（AI）**
   → 将原始文本/口述解析为结构化实体：事件元信息、灾型参数（震级/震中/发震时刻/烈度带）、地域要素（山体/河流/设施）、关键风险（滑坡/堰塞湖/桥梁受损概率等），写入实体表并驱动三维地图分层展示。
3. **AI生成建议任务包（AI→指挥员）**
   → 给出每车“装备-物资-无人装备”建议清单、体积/重量/功耗/续航校核、优先级与理由说明，并形成“到点清单（Checklists）”。
4. **任务下发（指挥员→各车）**
   → 指挥员可整体/逐车确认或修改后下发；系统记录版本号与生效时间窗。
5. **车辆二次调整并提交（各车→AI）**
   → 车组按专业与实际可用性调整，自动校验冲突（超载、互斥装备、重复装载、缺关键件），提交后生成“变更单”。
6. **差异汇总与风险复核（AI→指挥员）**
   → 系统输出“推荐 vs 最终”的差异列表、影响评估与补救建议，待指挥员确认。
7. **准备状态看板达成“全绿”**
   → 所有车辆达成“准备就绪”状态（包含通信链路/电量/自检通过）。
8. **出发命令签发（指挥员）**
   → 广播“出发”并冻结准备阶段数据，进入“机动前突”。

---

## 4. 功能需求（Functional Requirements）

### FR-01 事件通报（强制高闪一直播报）

* **触发**：上级指挥大厅推送 `EventCreated/Updated`。
* **UI/交互**：

  * 顶部红色高闪横幅 + 倒计时；TTS 连播关键三要素（何地/何时/何事）。
  * 10 秒内不可关闭；关闭需“指挥员”二次确认（口令或生物特征）。
* **数据**：记录首次到达时间、首次可见时间、确认人、确认时间、TTS 播放次数。
* **验收**：消息到达≤1s 上屏；90% 终端在3s内完成TTS首句播报；确认日志具备审计链。

### FR-02 事件初始态势结构化

* **输入**：文本/语音（ASR 转写）、附件（图/表）。
* **处理**：命名实体识别（地点、灾型参数）、时空绑定、灾型模板填充（地震字段：震级、震源深度、烈度估计、余震概率）。
* **输出**：实体表 `Event`, `Hazard`, `Region`, `RiskHotspot`, `Constraint`，并生成 GeoJSON/3D Tiles 图层。
* **验收**：解析延迟≤5s；关键字段完整度≥95%；错误回退至手工编辑侧栏。

> 注：可调用“知识图谱推理”“多源数据融合”“态势自动标绘智能体”。

### FR-03 三维“一张图”展示

* **图层**：事件范围/烈度带、地形坡度、河网/桥梁/道路、潜在滑坡与堰塞湖、避难点、车辆与仓储点。
* **交互**：图层开关、热区点击卡片、路径预估叠加、实体时间线。
* **性能**：>60 FPS（桌面端）、首屏≤2s，离线瓦片缓存可用。
* **标准**：WGS84、EPSG:3857；支持 3D Tiles/GeoJSON。

### FR-04 AI装备/物资/无人装备智能推荐

* **目标**：按灾型+地域+维稳要求，生成“车-装-物-无人装备”建议清单与优先级。
* **约束**：车辆载重/体积、功耗/充电窗口、作业时隙、人员资质、通信链路能力。
* **示例**（地震山地近河场景）：

  * 必备：破拆套件、起重气垫、生命探测、无人侦察（光/热）、测绘建模无人机、卫星通信、医疗急救、绳索救援、应急照明、应急电源、涉水装备。
  * 建议：机器人犬（侦察/运载）、大型救援无人机（投送）。
* **可解释性**：每项推荐给出“触发规则/模型理由”（如“坡陡>15°触发滑坡概率中高→绳索救援↑”）。
* **模型与智能体**：灾害预测评估模型、救援方案生成模型、智能资源调度/任务智能分解/实时风险评估等。
* **验收**：推荐生成≤8s；解释覆盖率100%；与指挥员手工方案相比，关键能力缺失率趋近0。

### FR-05 任务下发与版本化

* **内容**：逐车任务卡、装载清单、到点检查、通信配置（主/备链路）、出动窗口、注意事项。
* **机制**：指挥员可“全量确认”或“逐车确认”；生成 `IssuePackage vX.Y` 并广播。
* **回执**：各车必须 `ACK`；超时未回执触发二级提醒（TTS+短信/卫星短报）。

### FR-06 车辆二次调整与冲突校验

* **交互**：装载界面支持搜索/拖拽/模板应用；显示重量/体积/功耗表盘与阈值。
* **规则**：

  * 载重/体积超限禁止提交；关键件（如“破拆工具-动力源”）缺失禁止提交；互斥（同频干扰/同仓位冲突）警示。
  * 支持“专业偏好集”（消防/测绘/医疗等）一键替换。
* **输出**：变更单 `ChangeSet`（变更理由、影响范围、替代方案）。
* **验收**：校验实时（<100ms）；提交成功回执≤1s。

### FR-07 变更汇总与风险复核

* **目标**：向指挥员呈现“推荐 vs 最终”差异矩阵与影响评估。
* **内容**：缺项、替换、数量变化、风险补救建议；一键回退/一键接受。
* **验收**：可视化差异对比直观；关键缺项有红线拦截策略。

### FR-08 准备状态总览（就绪看板）

* **指标**：车组准备状态（绿色/黄色/红色）、通信链路自检、无人装备健康度、电量/耗材阈值、人员到位、任务理解确认（ASR 口令复述可选）。
* **门槛**：所有车组“全绿”方可点亮“出发”按钮；否则需“风险签署”强制放行留痕。
* **自检**：调用“装备自检与健康诊断”。

### FR-09 出发命令与阶段闭环

* **行为**：签发“出发”；广播至车队与上级；冻结准备阶段数据（版本化归档）。
* **联动**：自动切换到“机动前突”界面并启动路线预规划与通信保障策略。

---

## 5. 地震场景业务规则（示例，可配置）

* **震级/烈度与装备映射**（工作规则示意）

  * M≥6.0 且山区：强制加入绳索/破拆/生命探测/测绘建模无人机/卫星链路；预测滑坡与堰塞湖并上图。
  * 距主河道≤2km：涉水装备、无人艇备选；大流量泵、抛投救生。
  * 余震概率高：加强个人防护/分散指挥点，指挥所智能选址远离危旧高层。
* **维稳/人文**：敏感设施、学校/医院优先级权重上调；舆情与聚集风险作为策略因子。
* **通信**：主链路（5G/专网）不可用则自动切换卫星/中继；上报带宽按优先级分配。

---

## 6. 数据模型（核心实体与字段草案）

> **统一标识**：使用 ULID；所有实体具备 `version`, `created_by`, `updated_by`, `audit_trail[]`。

* **Event**：`id`, `type`, `title`, `time_occurred`, `time_reported`, `source`, `status`, `severity`, `area_polygon`, `attachments[]`, `constraints[]`
* **Hazard(EQ)**：`magnitude`, `depth_km`, `intensity_estimate`, `aftershock_risk`, `secondary_hazards[]`
* **Region**：`name`, `terrain_profile`(slope, elevation), `hydrology`(rivers, lakes), `infrastructure`(roads, bridges, shelters)
* **Vehicle**：`id`, `callsign`, `capacity_weight`, `capacity_volume`, `power_slots`, `comms_profiles[]`
* **Equipment**：`sku`, `name`, `category`, `weight`, `volume`, `power`, `must_with`（依赖）, `mutex_with`
* **UnmannedAsset**：`type`(UAV/UGV/USV/RobotDog), `payloads[]`, `endurance`, `spectrum`
* **Loadout**：`vehicle_id`, `items[]`(sku, qty), `power_budget`, `checklist[]`, `status`
* **ChangeSet**：`vehicle_id`, `diff[]`(add/remove/qty_change), `reason`, `impact`(risk, coverage), `approved_by`, `approved_at`
* **Readiness**：`vehicle_id`, `self_test`(pass/fail), `comms`, `battery`, `personnel`, `timestamp`
* **Command**：`type`(issue/recall/depart), `issued_by`, `issued_at`, `targets[]`

**示例：Loadout（JSON）**

```json
{
  "vehicle_id": "V-Alpha",
  "items": [
    {"sku": "CUT-RESCUE-SET", "qty": 1},
    {"sku": "UAV-MAP-RTK", "qty": 1},
    {"sku": "SATCOM-KIT", "qty": 1},
    {"sku": "LIFE-DETECTOR", "qty": 1}
  ],
  "power_budget": {"available_wh": 6000, "required_wh": 5200},
  "checklist": ["工具固定", "电池满电", "固件更新校验"],
  "status": "READY_PENDING_APPROVAL"
}
```

---

## 7. 接口设计（草案）

### 7.1 事件与播报

* `POST /api/v1/events/ingest`：上级通报入库（支持签名校验）
* `WS topic: /events/{id}/broadcast`：高闪播报与TTS触发
* `POST /api/v1/events/{id}/ack`：指挥员确认（含二次认证）

### 7.2 态势结构化与上图

* `POST /ai/parse/situation`：输入文本/语音转写；输出实体包
* `POST /entities/bulk_upsert`：批量写入 `Event/Hazard/Region/RiskHotspot`
* `GET /map/layers?event_id=...`：返回 GeoJSON/3D Tiles 图层清单

### 7.3 推荐与任务包

* `POST /ai/recommend/loadout`：输入事件+地域+约束→输出建议清单与解释
* `POST /orders/issue`：指挥员下发任务包（版本化）
* `POST /loadouts/{vehicle}/submit`：车辆提交调整→生成 `ChangeSet`
* `GET /orders/diff?event_id=...`：汇总差异与影响
* `GET /readiness/summary`：就绪看板数据

### 7.4 通信与离线

* MQTT 作为车端消息总线（QoS1/2，Store&Forward）；链路策略由“通信协调智能体”下发。

---

## 8. UI/UE 关键要点

* **高闪条**：首屏置顶、红色闪烁、TTS 同步，支持“演练模式”降噪。
* **三维地图侧栏**：实体树（事件/风险/设施/资源/任务），点击高亮与联动飞行。
* **装载面板**：卡片化装备库、拖拽到车辆货架、仪表盘实时校核（重量/体积/功耗）。
* **差异面板**：多列对比（推荐/最终/差异/影响），支持一键回退。
* **就绪看板**：车辆卡片红黄绿，缺项显式列出，点击展开检查清单。
* **可访问性**：低光/强光/夜间模式；ASR 口令与TTS播报。

---

## 9. 规则、合规模块与非功能性

### 9.1 校验规则汇总

* **硬约束**：载重/体积/关键件缺失/互斥；不通过则禁止提交。
* **软约束**：覆盖度（视觉/热成像/测绘/通信/医疗）不足→黄牌提示并给出替代建议。
* **指挥授权**：可“带风险出发”，必须填写风险签署原因与补救计划。

### 9.2 性能与时延

* 事件上屏 ≤1s；结构化解析 ≤5s；推荐生成 ≤8s；提交回执 ≤1s；三维地图首屏 ≤2s。

### 9.3 可用性与容灾

* 核心服务可用性 ≥99.9%；断链离线可运行（本地缓存、事务重放），多网通信管理与自动切换。

### 9.4 日志与审计

* 全链路采集（指令、修改、确认、出发），支持追溯与合规校验。

### 9.5 安全与权限

* 分级分域、最小权限、敏感操作二次认证、端到端加密；支持 OTA 灰度与回滚。

---

## 10. 验收标准与测试用例（节选）

1. **高闪播报稳定性**：在 30 台终端并发下，≥90% 终端 3s 内TTS首句播出；全部终端 UI 同步一致。
2. **结构化正确性**：以 50 条历史地震通报为基准，关键字段准确率≥95%。
3. **推荐完整性**：对比专家基线，关键能力缺项率=0；理由解释覆盖率=100%。
4. **装载校验**：制造 20 种冲突场景全部被正确阻断或警示。
5. **差异面板**：对 10 份“车辆自改清单”生成一致的差异与影响结论。
6. **就绪门槛**：未“全绿”无法签发出发；强制放行需生成风险签署记录。
7. **离线提交**：断网 10 分钟期间本地提交排队，恢复后 30 秒内全部重放成功并去重。
8. **审计追溯**：随机抽查任意一车的装载变更链路，能完整重放。
9. **多语种ASR/TTS**：方言口令成功率 ≥90%，关键事件 TTS 正确播报。
10. **安全**：权限绕过与接口越权扫描为 0；密钥轮换不影响在线任务。

---

## 11. 异常与兜底

* 事件重复/撤回：保留多版本，最新标记为有效，地图与看板自动切换。
* 推荐失败：回退到“模板+向导式选择”；提示失败原因与所需最小输入。
* 车辆长期不回执：升级为指挥车直呼叫（卫星/中继），并触发替补车辆准备。
* 关键装备缺货：自动给出替代组合与能力损失评估。

---

## 12. 实体-图层映射（示例）

* **事件范围**→多边形（红色半透明）；**烈度带**→等值面；**风险热点**→热力图；
* **道路/桥梁/河流**→线/面要素；**车辆/仓储**→图标+状态色；**任务点**→编号旗标。

---

## 13. 模型与智能体对接（映射表）

* **灾害预测评估模型**：地震参数→次生灾害概率与空间分布。
* **救援方案生成模型**：生成“行动/装载”组合与时序。
* **应急救援知识推理模型**：约束校验与合规性规则。
* **智能体**：态势自动标绘、智能资源调度、任务智能分发、通信协调、预警监测、实时风险评估、多机协同控制、ASR/TTS 等用于本阶段各环节联动。

---

## 14. 里程碑（建议）

* **M1（2 周）**：事件高闪、结构化入库、三维上图（基础层）。
* **M2（4 周）**：推荐引擎 v1、装载校验、变更面板、就绪看板。
* **M3（6 周）**：离线能力、审计合规、ASR/TTS、通信策略联动。
* **M4（8 周）**：地震场景规则完善、性能与可靠性压测、验收与演练。

---

### 附：数据字典（摘录）

* **无人装备类型**：`UAV_MAP`(扫图建模)，`UAV_RECON`(侦察)，`UAV_HEAVY`(大型投送)，`ROBOT_DOG_RECON`，`ROBOT_DOG_LOGI`。
* **关键件依赖示例**：`LIFE_DETECTOR` 依赖 `POWER_PACK`; `CUT-RESCUE-SET` 依赖 `PPE-SET`。
* **状态枚举**：`READY_PENDING_APPROVAL` / `READY` / `BLOCKED` / `FORCE_START_WITH_RISK`.

---

**落地建议**：优先完成“地震场景”的规则模板与装备库标注，再扩展到洪涝/火灾等灾型的参数化插件。本说明书可直接作为开发 Backlog 的来源，后续我可以输出接口 Swagger 草案与就绪看板的原型稿。
