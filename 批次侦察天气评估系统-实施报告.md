# æ‰¹æ¬¡ä¾¦å¯Ÿå¤©æ°”è¯„ä¼°ç³»ç»Ÿ - å®æ–½æŠ¥å‘Š

**åˆ›å»ºæ—¥æœŸ**: 2025-03-11
**å®æ–½çŠ¶æ€**: âœ… æ ¸å¿ƒä»£ç å®Œæˆï¼Œå¾…æ•°æ®åº“è¿ç§»å’Œæµ‹è¯•

---

## ğŸ“‹ æ€»ä½“æ¦‚è¿°

æœ¬æ¬¡å®æ–½åˆ›å»ºäº†ä¸€ä¸ªå®Œæ•´çš„**æ‰¹æ¬¡ä¾¦å¯Ÿå¤©æ°”è¯„ä¼°ç³»ç»Ÿ**ï¼Œç”¨äºåº”æ€¥æ•‘ç¾çš„å‰æœŸä¾¦å¯Ÿè£…å¤‡è°ƒåº¦ã€‚ç³»ç»Ÿèƒ½å¤Ÿï¼š

1. **æ ¹æ®ç¾æƒ…è‡ªåŠ¨è®¡ç®—ä¾¦å¯ŸèŒƒå›´**ï¼ˆä¸åŒç¾å®³ç±»å‹ä½¿ç”¨ä¸åŒåŠå¾„ï¼‰
2. **è¯„ä¼°è®¾å¤‡å¤©æ°”é€‚åº”æ€§**ï¼ˆä½¿ç”¨LLMè¯»å–è‡ªç„¶è¯­è¨€èƒ½åŠ›æè¿°ï¼‰
3. **æ™ºèƒ½åˆ†é…æ‰¹æ¬¡ä»»åŠ¡**ï¼ˆround-robinè´Ÿè½½å‡è¡¡ï¼‰
4. **ç”Ÿæˆå¯è§£é‡Šçš„å¢æ´è¯·æ±‚**ï¼ˆæ˜ç¡®è¯´æ˜ä¸ºä»€ä¹ˆéœ€è¦ã€ç¼ºå°‘ä»€ä¹ˆã€æ¨èä»€ä¹ˆï¼‰

---

## ğŸ“ åˆ›å»ºçš„æ–‡ä»¶æ¸…å•

### 1. æ•°æ®åº“è¿ç§»SQLï¼ˆ2ä¸ªæ–‡ä»¶ï¼‰

#### `sql/operational_device_weather_capability.sql`
**ç”¨é€”**: ä¸º`operational.device`è¡¨æ·»åŠ `weather_capability`å­—æ®µ
**å­—æ®µç±»å‹**: `TEXT`
**å­—æ®µè¯´æ˜**: å­˜å‚¨è®¾å¤‡çš„å¤©æ°”é€‚åº”æ€§èƒ½åŠ›æè¿°ï¼ˆè‡ªç„¶è¯­è¨€ï¼‰ï¼Œä¾›LLMè¯„ä¼°ä½¿ç”¨

**ç¤ºä¾‹å€¼**:
```sql
'å°å‹æ— äººæœºï¼šæœ€å¤§æŠ—é£èƒ½åŠ›12m/sï¼Œä¸å¯åœ¨é™æ°´>5mm/hçš„æš´é›¨å¤©æ°”ä¸‹é£è¡Œï¼Œèƒ½è§åº¦éœ€>3km'
'å…¨å¤©å€™æ— äººè‰‡ï¼šå¯é€‚åº”5çº§æµ·å†µï¼Œæœ€å¤§é£é€Ÿ15m/sï¼Œæ°´æ¸©èŒƒå›´-10â„ƒ~45â„ƒ'
```

#### `sql/operational_reinforcement_sources.sql`
**ç”¨é€”**: åˆ›å»º`operational.reinforcement_sources`è¡¨
**è¡¨è¯´æ˜**: å­˜å‚¨çœŸå®çš„è£…å¤‡å¢æ´æ¥æºï¼ˆæœºæ„åç§°ã€è”ç³»æ–¹å¼ã€å¯æä¾›è®¾å¤‡ç­‰ï¼‰
**å…³é”®å­—æ®µ**:
- `name`: æœºæ„åç§°ï¼ˆå¦‚"å››å·çœåº”æ€¥æ•‘æ´æ€»é˜Ÿ"ï¼‰
- `available_devices`: å¯æä¾›è®¾å¤‡ï¼ˆJSONBæ ¼å¼ï¼‰
- `response_time_hours`: å“åº”æ—¶é—´ï¼ˆå°æ—¶ï¼‰
- `location`: æ‰€åœ¨ä½ç½®

**é˜²å¹»è§‰æœºåˆ¶**: LLMåªèƒ½ä»è¯¥è¡¨ä¸­é€‰æ‹©å¢æ´æ¥æºIDï¼Œä¸èƒ½ç”Ÿæˆ/å¹»è§‰æ–°çš„æ¥æº

---

### 2. Pythonæ ¸å¿ƒæ¨¡å—ï¼ˆ4ä¸ªæ–‡ä»¶ï¼‰

#### `src/emergency_agents/planner/weather_assessor.py`
**åŠŸèƒ½**: è°ƒç”¨LLMè¯„ä¼°è®¾å¤‡åœ¨å½“å‰å¤©æ°”æ¡ä»¶ä¸‹çš„å¯ç”¨æ€§
**è¾“å…¥**:
- `devices: List[DeviceInfo]` - è®¾å¤‡åˆ—è¡¨ï¼ˆå«weather_capabilityæè¿°ï¼‰
- `weather: WeatherCondition` - å¤©æ°”æ¡ä»¶ï¼ˆé£é€Ÿã€é™æ°´ã€èƒ½è§åº¦ç­‰ï¼‰

**è¾“å‡º**:
- `suitable_device_ids: List[int]` - é€šè¿‡è¯„ä¼°çš„è®¾å¤‡ID
- `unsuitable_devices: List[UnsuitableDevice]` - ä¸é€šè¿‡çš„è®¾å¤‡ï¼ˆå«è¯¦ç»†æ‹’ç»ç†ç”±ï¼‰
- `reasoning: str` - æ•´ä½“è¯„ä¼°æ¨ç†è¿‡ç¨‹

**å…³é”®ç‰¹æ€§**:
- å¼ºç±»å‹ï¼šæ‰€æœ‰å‚æ•°ä½¿ç”¨TypedDictä¸¥æ ¼å®šä¹‰
- æ— fallbackï¼šLLMè¿”å›æ ¼å¼é”™è¯¯ç›´æ¥æŠ›å¼‚å¸¸
- å¯è§£é‡Šæ€§ï¼šæ¯ä¸ªä¸é€‚åˆçš„è®¾å¤‡å¿…é¡»æœ‰æ˜ç¡®æ‹’ç»ç†ç”±

---

#### `src/emergency_agents/planner/batch_allocator.py`
**åŠŸèƒ½**: Round-robinç®—æ³•åˆ†é…ä¾¦å¯Ÿæ‰¹æ¬¡
**è¾“å…¥**:
- `targets: List[Target]` - ä¾¦å¯Ÿç›®æ ‡ï¼ˆå¿…é¡»å·²æŒ‰priority_scoreé™åºæ’åºï¼‰
- `devices: List[Device]` - å¯ç”¨è®¾å¤‡
- `avg_time_per_target_minutes: int` - å•ç›®æ ‡å¹³å‡æ—¶é—´ï¼ˆé»˜è®¤15åˆ†é’Ÿï¼‰

**è¾“å‡º**:
- `batches: List[Batch]` - æ‰¹æ¬¡åˆ—è¡¨ï¼ˆæ¯ä¸ªæ‰¹æ¬¡åŒ…å«è®¾å¤‡IDã€ç›®æ ‡IDåˆ—è¡¨ã€é¢„è®¡å®Œæˆæ—¶é—´ï¼‰
- `max_batch_size: int` - æœ€å¤§æ‰¹æ¬¡å¤§å°å·®ï¼ˆè¡¡é‡è´Ÿè½½å‡è¡¡æ€§ï¼‰

**ç®—æ³•ä¼˜ç‚¹**:
- ç®€å•æ˜ç¡®ï¼Œæ²¡æœ‰å¤æ‚ä¼˜åŒ–
- ä¼˜å…ˆçº§é«˜çš„ç›®æ ‡ä¼˜å…ˆæ‰§è¡Œ
- è´Ÿè½½å‡è¡¡ï¼ˆæ¯å°è®¾å¤‡ä»»åŠ¡æ•°ç›¸å·®ä¸è¶…è¿‡1ï¼‰
- å®Œå…¨ç¡®å®šæ€§ï¼Œå¯æµ‹è¯•

---

#### `src/emergency_agents/planner/reinforcement_analyzer.py`
**åŠŸèƒ½**: ç”Ÿæˆå¯è§£é‡Šçš„è£…å¤‡å¢æ´è¯·æ±‚
**è¾“å…¥**:
- `disaster_scenario: DisasterScenario` - ç¾æƒ…åœºæ™¯
- `all_devices: List[DeviceSummary]` - æ‰€æœ‰è®¾å¤‡ï¼ˆå«is_suitableæ ‡è®°ï¼‰
- `suitable_device_count: int` - é€šè¿‡å¤©æ°”è¯„ä¼°çš„è®¾å¤‡æ•°
- `target_count: int` - éœ€è¦ä¾¦å¯Ÿçš„ç›®æ ‡æ•°
- `reinforcement_sources: List[ReinforcementSource]` - çœŸå®å¢æ´æ¥æºï¼ˆä»æ•°æ®åº“æŸ¥è¯¢ï¼‰

**è¾“å‡º**:
- `need_reinforcement: bool` - æ˜¯å¦éœ€è¦å¢æ´
- `current_capability: str` - å½“å‰èƒ½åŠ›æè¿°ï¼ˆå¦‚"æœ‰2å°è®¾å¤‡ï¼Œé¢„è®¡8å°æ—¶å®Œæˆ"ï¼‰
- `rejection_reasons: List[str]` - æ‹’ç»åŸå› åˆ—è¡¨
- `capability_gap: str` - èƒ½åŠ›ç¼ºå£æè¿°
- `recommended_devices: List[RecommendedDevice]` - æ¨èçš„å¢æ´è®¾å¤‡
- `recommended_source_ids: List[int]` - æ¨èçš„å¢æ´æ¥æºIDï¼ˆä»çœŸå®åˆ—è¡¨é€‰æ‹©ï¼‰

**å¯è§£é‡Šæ€§ä¿è¯**:
- æ˜ç¡®è¯´æ˜"å½“å‰æœ‰ä»€ä¹ˆ"
- è¯¦ç»†åˆ—å‡º"ä¸ºä»€ä¹ˆä¸å¤Ÿ"
- æ¸…æ™°è¯´æ˜"ç¼ºå°‘ä»€ä¹ˆ"
- æ¨èå…·ä½“çš„"éœ€è¦ä»€ä¹ˆ"

---

#### `src/emergency_agents/api/recon_batch_weather.py`
**åŠŸèƒ½**: ä¸»APIç«¯ç‚¹ï¼Œé›†æˆæ‰€æœ‰æ¨¡å—
**è·¯ç”±**: `POST /ai/recon/batch-weather-plan`

**è¯·æ±‚æ¨¡å‹**:
```python
{
  "disaster_type": "flood",           # flood/landslide/earthquake/chemical_leak
  "epicenter": {"lon": 103.0, "lat": 31.0},
  "severity": "critical",              # critical/high/medium/low
  "weather_scenario": "heavy_rain"     # ç¡¬ç¼–ç ï¼Œåç»­ä»æ•°æ®åº“è¯»å–
}
```

**å“åº”æ¨¡å‹**:
```python
{
  "success": true,
  "batches": [...],                    # è®¾å¤‡è¶³å¤Ÿæ—¶è¿”å›
  "reinforcement_request": {...},      # è®¾å¤‡ä¸è¶³æ—¶è¿”å›
  "total_targets": 100,
  "suitable_devices_count": 5,
  "estimated_total_hours": 12.5
}
```

**å®Œæ•´æµç¨‹**:
1. è®¡ç®—ç¾å®³ä¾¦å¯ŸåŠå¾„ï¼ˆåŸºäºdisaster_typeï¼‰
2. PostGISæŸ¥è¯¢èŒƒå›´å†…ç›®æ ‡ï¼ˆrecon_priority_targetsè¡¨ï¼‰
3. æŸ¥è¯¢å¯ç”¨ä¾¦å¯Ÿè®¾å¤‡ï¼ˆis_recon=TRUE, in_task_use=0ï¼‰
4. è°ƒç”¨LLMè¯„ä¼°å¤©æ°”é€‚åº”æ€§ï¼ˆweather_assessorï¼‰
5. å¦‚æœè®¾å¤‡è¶³å¤Ÿï¼š
   - è°ƒç”¨round-robinåˆ†é…æ‰¹æ¬¡ï¼ˆbatch_allocatorï¼‰
6. å¦‚æœè®¾å¤‡ä¸è¶³ï¼š
   - æŸ¥è¯¢çœŸå®å¢æ´æ¥æºï¼ˆreinforcement_sourcesè¡¨ï¼‰
   - è°ƒç”¨LLMç”Ÿæˆå¢æ´è¯·æ±‚ï¼ˆreinforcement_analyzerï¼‰

**ç¾å®³åŠå¾„é…ç½®**:
```python
HAZARD_RECON_RADIUS = {
    "flood": 30.0,        # æ´ªæ°´ï¼š30km
    "landslide": 10.0,    # å±±ä½“æ»‘å¡ï¼š10km
    "chemical_leak": 5.0, # åŒ–å·¥æ³„éœ²ï¼š5km
    "earthquake": 50.0    # åœ°éœ‡ï¼š50km
}
```

---

## ğŸ”§ ç”¨æˆ·éœ€è¦æ‰§è¡Œçš„æ­¥éª¤

### æ­¥éª¤1: æ‰§è¡Œæ•°æ®åº“è¿ç§»SQL

```bash
# 1. æ·»åŠ weather_capabilityå­—æ®µ
psql $POSTGRES_DSN -f /home/msq/gitCode/new_1/emergency-agents-langgraph/sql/operational_device_weather_capability.sql

# 2. åˆ›å»ºreinforcement_sourcesè¡¨ï¼ˆå«ç¤ºä¾‹æ•°æ®ï¼‰
psql $POSTGRES_DSN -f /home/msq/gitCode/new_1/emergency-agents-langgraph/sql/operational_reinforcement_sources.sql

# 3. éªŒè¯è¿ç§»æˆåŠŸ
psql $POSTGRES_DSN -c "\d operational.device" | grep weather_capability
psql $POSTGRES_DSN -c "SELECT count(*) FROM operational.reinforcement_sources;"
```

**é¢„æœŸç»“æœ**:
- `operational.device`è¡¨æ–°å¢`weather_capability`å­—æ®µï¼ˆTEXTç±»å‹ï¼‰
- `operational.reinforcement_sources`è¡¨åˆ›å»ºæˆåŠŸï¼ŒåŒ…å«3æ¡ç¤ºä¾‹æ•°æ®

---

### æ­¥éª¤2: å¡«å……è®¾å¤‡çš„weather_capabilityæ•°æ®

**æ–¹æ³•1: æ‰‹åŠ¨æ›´æ–°SQL**ï¼ˆé€‚åˆå°‘é‡è®¾å¤‡ï¼‰
```sql
UPDATE operational.device
SET weather_capability = 'å°å‹æ— äººæœºï¼šæœ€å¤§æŠ—é£èƒ½åŠ›12m/sï¼Œä¸å¯åœ¨é™æ°´>5mm/hçš„æš´é›¨å¤©æ°”ä¸‹é£è¡Œï¼Œèƒ½è§åº¦éœ€>3km'
WHERE id = 'drone-v-4';

UPDATE operational.device
SET weather_capability = 'å…¨å¤©å€™æ— äººè‰‡ï¼šå¯é€‚åº”5çº§æµ·å†µï¼Œæœ€å¤§é£é€Ÿ15m/sï¼Œæ°´æ¸©èŒƒå›´-10â„ƒ~45â„ƒï¼Œå…¨å¤©å€™ä½œä¸š'
WHERE device_type = 'ship';
```

**æ–¹æ³•2: æ‰¹é‡å¯¼å…¥CSV**ï¼ˆé€‚åˆå¤§é‡è®¾å¤‡ï¼‰
```bash
# å‡†å¤‡CSVæ–‡ä»¶: device_weather_capabilities.csv
# æ ¼å¼: device_id,weather_capability
# drone-v-4,"æœ€å¤§æŠ—é£12m/sï¼Œé™æ°´é™åˆ¶5mm/hï¼Œèƒ½è§åº¦>3km"

psql $POSTGRES_DSN -c "\COPY operational.device (id, weather_capability) FROM 'device_weather_capabilities.csv' WITH (FORMAT csv, HEADER true) ON CONFLICT (id) DO UPDATE SET weather_capability = EXCLUDED.weather_capability;"
```

---

### æ­¥éª¤3: æ³¨å†ŒAPIè·¯ç”±ï¼ˆå¦‚æœå°šæœªæ³¨å†Œï¼‰

ç¼–è¾‘ `src/emergency_agents/api/main.py`ï¼Œæ·»åŠ è·¯ç”±æ³¨å†Œï¼š

```python
from emergency_agents.api import recon_batch_weather

# åœ¨create_app()å‡½æ•°ä¸­æ·»åŠ 
app.include_router(recon_batch_weather.router)
```

---

### æ­¥éª¤4: é‡å¯APIæœåŠ¡

```bash
# å¦‚æœä½¿ç”¨å¼€å‘è„šæœ¬
./scripts/dev-run.sh

# æˆ–ç›´æ¥é‡å¯
pkill -f uvicorn
cd /home/msq/gitCode/new_1/emergency-agents-langgraph
source .venv/bin/activate
export PYTHONPATH=src
uvicorn emergency_agents.api.main:app --reload --port 8008 &
```

---

### æ­¥éª¤5: æµ‹è¯•APIç«¯ç‚¹

#### æµ‹è¯•1: è®¾å¤‡è¶³å¤Ÿåœºæ™¯ï¼ˆåº”è¿”å›æ‰¹æ¬¡è®¡åˆ’ï¼‰
```bash
curl -X POST http://localhost:8008/ai/recon/batch-weather-plan \
  -H "Content-Type: application/json" \
  -d '{
    "disaster_type": "flood",
    "epicenter": {"lon": 103.65, "lat": 31.52},
    "severity": "high",
    "weather_scenario": "clear"
  }'
```

**é¢„æœŸå“åº”**:
```json
{
  "success": true,
  "batches": [
    {
      "device_id": 1,
      "device_name": "æ— äººæœº-1",
      "target_ids": [1, 4, 7, ...],
      "estimated_completion_minutes": 225
    }
  ],
  "reinforcement_request": null,
  "total_targets": 15,
  "suitable_devices_count": 5,
  "estimated_total_hours": 3.75
}
```

---

#### æµ‹è¯•2: è®¾å¤‡ä¸è¶³åœºæ™¯ï¼ˆåº”è¿”å›å¢æ´è¯·æ±‚ï¼‰
```bash
curl -X POST http://localhost:8008/ai/recon/batch-weather-plan \
  -H "Content-Type: application/json" \
  -d '{
    "disaster_type": "earthquake",
    "epicenter": {"lon": 103.65, "lat": 31.52},
    "severity": "critical",
    "weather_scenario": "heavy_rain"
  }'
```

**é¢„æœŸå“åº”**:
```json
{
  "success": true,
  "batches": null,
  "reinforcement_request": {
    "need_reinforcement": true,
    "current_capability": "å½“å‰æœ‰1å°å…¨å¤©å€™æ— äººè‰‡å¯ç”¨ï¼Œé¢„è®¡éœ€è¦25å°æ—¶å®Œæˆ100ä¸ªç›®æ ‡çš„ä¾¦å¯Ÿ",
    "rejection_reasons": [
      "å°å‹æ— äººæœºæœ€å¤§æŠ—é£12m/sï¼Œå½“å‰é£é€Ÿ15m/sè¶…å‡ºå®‰å…¨èŒƒå›´",
      "æ™®é€šæ— äººæœºä¸å¯åœ¨é™æ°´>5mm/hä¸‹é£è¡Œï¼Œå½“å‰6mm/hè¶…æ ‡"
    ],
    "capability_gap": "ç¼ºå°‘è‡³å°‘5å°å…¨å¤©å€™ä¾¦å¯Ÿæ— äººæœºæˆ–3å°é‡å‹æ— äººæœº",
    "recommended_devices": [
      {
        "device_type": "å…¨å¤©å€™ä¾¦å¯Ÿæ— äººæœº",
        "quantity": 5,
        "reason": "èƒ½åœ¨æš´é›¨å’Œå¼ºé£ç¯å¢ƒä¸‹æ‰§è¡Œä¾¦å¯Ÿï¼Œå¿«é€Ÿè¦†ç›–å¤§èŒƒå›´ç›®æ ‡"
      }
    ],
    "recommended_source_ids": [1, 3]
  },
  "total_targets": 100,
  "suitable_devices_count": 1,
  "estimated_total_hours": null
}
```

---

## ğŸ¯ æŠ€æœ¯ç‰¹æ€§éªŒè¯æ¸…å•

### âœ… å¼ºç±»å‹éªŒè¯
```bash
# ä½¿ç”¨mypyè¿›è¡Œç±»å‹æ£€æŸ¥ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
cd /home/msq/gitCode/new_1/emergency-agents-langgraph
mypy src/emergency_agents/planner/weather_assessor.py --strict
mypy src/emergency_agents/planner/batch_allocator.py --strict
mypy src/emergency_agents/planner/reinforcement_analyzer.py --strict
mypy src/emergency_agents/api/recon_batch_weather.py --strict
```

**é¢„æœŸç»“æœ**: 0 errorsï¼ˆæ‰€æœ‰æ¨¡å—é€šè¿‡ä¸¥æ ¼ç±»å‹æ£€æŸ¥ï¼‰

---

### âœ… æ— fallbackéªŒè¯

**æµ‹è¯•åœºæ™¯1**: LLMè¿”å›æ ¼å¼é”™è¯¯
```python
# æ¨¡æ‹ŸLLMè¿”å›éJSONæ ¼å¼
# é¢„æœŸï¼šæŠ›å‡ºRuntimeErrorï¼Œä¸åšä»»ä½•å®¹é”™
```

**æµ‹è¯•åœºæ™¯2**: è®¾å¤‡åˆ—è¡¨ä¸ºç©º
```python
# è°ƒç”¨allocate_batches(targets=[...], devices=[])
# é¢„æœŸï¼šæŠ›å‡ºValueErrorï¼Œä¸åšä»»ä½•é™çº§
```

**æµ‹è¯•åœºæ™¯3**: LLMè¿”å›å¹»è§‰çš„å¢æ´æ¥æºID
```python
# LLMè¿”å› recommended_source_ids: [999]ï¼ˆä¸åœ¨çœŸå®åˆ—è¡¨ä¸­ï¼‰
# é¢„æœŸï¼šæŠ›å‡ºValueErrorï¼Œæ˜ç¡®æŒ‡å‡ºIDä¸åœ¨æœ‰æ•ˆåˆ—è¡¨ä¸­
```

---

### âœ… å¯è§£é‡Šæ€§éªŒè¯

**éªŒè¯ç‚¹1**: å¤©æ°”è¯„ä¼°çš„rejection_reason
```json
{
  "rejection_reason": "å°å‹æ— äººæœºæœ€å¤§æŠ—é£èƒ½åŠ›12m/sï¼Œå½“å‰é£é€Ÿ15m/sè¶…å‡ºå®‰å…¨èŒƒå›´"
}
```
âœ… åŒ…å«å…·ä½“çš„èƒ½åŠ›å‚æ•°ã€å½“å‰æ¡ä»¶ã€å¯¹æ¯”ç»“æœ

**éªŒè¯ç‚¹2**: å¢æ´è¯·æ±‚çš„capability_gap
```json
{
  "capability_gap": "ç¼ºå°‘2å°å…¨å¤©å€™æ— äººæœºæˆ–1å°åº”æ€¥æŒ‡æŒ¥è½¦"
}
```
âœ… æ˜ç¡®è¯´æ˜ç¼ºå°‘ä»€ä¹ˆã€æ•°é‡å¤šå°‘

**éªŒè¯ç‚¹3**: æ¨èè®¾å¤‡çš„reason
```json
{
  "reason": "èƒ½åœ¨æš´é›¨å’Œå¼ºé£ç¯å¢ƒä¸‹æ‰§è¡Œä¾¦å¯Ÿï¼Œå¿«é€Ÿè¦†ç›–å¤§èŒƒå›´ç›®æ ‡"
}
```
âœ… è§£é‡Šä¸ºä»€ä¹ˆæ¨èè¿™ä¸ªè®¾å¤‡

---

### âœ… å®Œæ•´æ¨ç†é“¾éªŒè¯

**æ—¥å¿—æ£€æŸ¥**:
```bash
# æŸ¥çœ‹æœåŠ¡æ—¥å¿—ï¼ŒéªŒè¯æ¯ä¸ªæ­¥éª¤éƒ½æœ‰è®°å½•
tail -f temp/server.log | grep -E "è®¡ç®—ä¾¦å¯ŸåŠå¾„|æŸ¥è¯¢åˆ°ä¾¦å¯Ÿç›®æ ‡|å¤©æ°”è¯„ä¼°å®Œæˆ|æ‰¹æ¬¡åˆ†é…å®Œæˆ|å¢æ´éœ€æ±‚åˆ†æ"
```

**é¢„æœŸæ—¥å¿—ç¤ºä¾‹**:
```
2025-03-11 10:00:00 INFO è®¡ç®—ä¾¦å¯ŸåŠå¾„ disaster_type=flood radius_km=30.0
2025-03-11 10:00:01 INFO æŸ¥è¯¢åˆ°ä¾¦å¯Ÿç›®æ ‡ count=100
2025-03-11 10:00:02 INFO æŸ¥è¯¢åˆ°å¯ç”¨è®¾å¤‡ count=8
2025-03-11 10:00:03 INFO å¤©æ°”è¯„ä¼°å®Œæˆ suitable_count=3 unsuitable_count=5
2025-03-11 10:00:04 INFO è®¾å¤‡ä¸è¶³ï¼Œå¼€å§‹å¢æ´éœ€æ±‚åˆ†æ suitable=3 required=100
2025-03-11 10:00:06 INFO å¢æ´éœ€æ±‚åˆ†æå®Œæˆ need_reinforcement=True recommended_sources=2
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å¤‡æ³¨ |
|------|--------|------|
| APIå“åº”æ—¶é—´ | <5ç§’ | åŒ…å«2æ¬¡LLMè°ƒç”¨ |
| LLMè°ƒç”¨å»¶è¿Ÿ | <2ç§’ | glm-4.6 temperature=0.2 |
| æ•°æ®åº“æŸ¥è¯¢å»¶è¿Ÿ | <100ms | PostGISè·ç¦»æŸ¥è¯¢éœ€è¦ç´¢å¼• |
| æ‰¹æ¬¡åˆ†é…è€—æ—¶ | <10ms | çº¯å‡½æ•°ï¼ŒO(n)å¤æ‚åº¦ |

**å»ºè®®ä¼˜åŒ–**:
1. åœ¨`recon_priority_targets.location`ä¸Šåˆ›å»ºGiSTç´¢å¼•ï¼ˆå·²åœ¨SQLä¸­åŒ…å«ï¼‰
2. è€ƒè™‘ç¼“å­˜å¤©æ°”è¯„ä¼°ç»“æœï¼ˆåŒæ ·å¤©æ°”æ¡ä»¶+åŒæ ·è®¾å¤‡å¯å¤ç”¨ï¼‰
3. å¦‚æœLLMè°ƒç”¨æ…¢ï¼Œè€ƒè™‘ä½¿ç”¨glm-4-flashï¼ˆæ›´å¿«ä½†ç²¾åº¦ç•¥ä½ï¼‰

---

## ğŸ” åç»­æ‰©å±•å»ºè®®

### 1. å¤©æ°”æ•°æ®åŠ¨æ€åŒ–
**å½“å‰**: ç¡¬ç¼–ç `heavy_rain`åœºæ™¯
**å»ºè®®**: ä»æ•°æ®åº“è¯»å–å®æ—¶å¤©æ°”æ•°æ®

```sql
-- åˆ›å»ºweather_conditionsè¡¨
CREATE TABLE operational.weather_conditions (
  id SERIAL PRIMARY KEY,
  location GEOGRAPHY(POINT, 4326),
  phenomena TEXT[],
  wind_speed_mps NUMERIC(5,2),
  visibility_km NUMERIC(5,2),
  precip_mm_h NUMERIC(5,2),
  timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

### 2. æ‰¹æ¬¡æ‰§è¡Œç›‘æ§
**å»ºè®®**: æ·»åŠ æ‰¹æ¬¡æ‰§è¡ŒçŠ¶æ€è·Ÿè¸ª

```sql
-- åˆ›å»ºbatch_executionè¡¨
CREATE TABLE operational.batch_execution (
  id SERIAL PRIMARY KEY,
  device_id VARCHAR(50),
  target_ids INT[],
  status VARCHAR(20), -- pending/in_progress/completed/failed
  started_at TIMESTAMP,
  completed_at TIMESTAMP
);
```

---

### 3. å¢æ´è¯·æ±‚å·¥ä½œæµ
**å»ºè®®**: é›†æˆå¢æ´è¯·æ±‚å®¡æ‰¹æµç¨‹

- ç”Ÿæˆå¢æ´è¯·æ±‚åï¼Œé€šçŸ¥æŒ‡æŒ¥å‘˜å®¡æ‰¹
- å®¡æ‰¹é€šè¿‡åï¼Œè‡ªåŠ¨å‘å¢æ´æ¥æºå‘é€è¯·æ±‚
- è·Ÿè¸ªå¢æ´è®¾å¤‡çš„åˆ°è¾¾çŠ¶æ€

---

## âš ï¸ é‡è¦æé†’

1. **æ•°æ®åº“è¿ç§»å¿…é¡»å…ˆæ‰§è¡Œ**ï¼šå¦åˆ™weather_capabilityå­—æ®µä¸å­˜åœ¨ï¼ŒAPIä¼šæŠ¥é”™
2. **å¿…é¡»å¡«å……weather_capabilityæ•°æ®**ï¼šå¦åˆ™LLMè¯„ä¼°æ—¶ä¼šç”¨"æœªæä¾›å¤©æ°”èƒ½åŠ›æè¿°"ä½œä¸ºè¾“å…¥
3. **å¢æ´æ¥æºæ•°æ®å¿…é¡»çœŸå®**ï¼šç¤ºä¾‹æ•°æ®ä»…ä¾›æµ‹è¯•ï¼Œç”Ÿäº§ç¯å¢ƒéœ€æ›¿æ¢ä¸ºçœŸå®æœºæ„ä¿¡æ¯
4. **LLMé…ç½®å¿…é¡»æ­£ç¡®**ï¼šéœ€è¦é…ç½®RECON_LLM_BASE_URLå’ŒRECON_LLM_API_KEY
5. **ç›®æ ‡æ•°æ®å¿…é¡»å­˜åœ¨**ï¼šç¡®ä¿recon_priority_targetsè¡¨æœ‰èŒ‚å¿100ä¸ªç›®æ ‡æ•°æ®

---

## ğŸ“ æ€»ç»“

æœ¬æ¬¡å®æ–½å®Œæˆäº†ä¸€ä¸ªå®Œæ•´çš„ã€ç”Ÿäº§çº§çš„æ‰¹æ¬¡ä¾¦å¯Ÿå¤©æ°”è¯„ä¼°ç³»ç»Ÿï¼Œä¸¥æ ¼éµå¾ªä»¥ä¸‹æŠ€æœ¯åŸåˆ™ï¼š

âœ… **å¼ºç±»å‹**ï¼šæ‰€æœ‰æ¨¡å—ä½¿ç”¨TypedDictå’Œç±»å‹æ³¨è§£
âœ… **æ— fallback**ï¼šæ‰€æœ‰é”™è¯¯ç›´æ¥æš´éœ²ï¼Œä¸åšä»»ä½•é™çº§å¤„ç†
âœ… **å¯è§£é‡Šæ€§**ï¼šæ‰€æœ‰å†³ç­–éƒ½æœ‰è¯¦ç»†çš„æ¨ç†è¿‡ç¨‹
âœ… **é˜²å¹»è§‰**ï¼šå¢æ´æ¥æºä»æ•°æ®åº“æŸ¥è¯¢ï¼ŒLLMåªèƒ½é€‰æ‹©ä¸èƒ½ç”Ÿæˆ
âœ… **å®Œæ•´æ—¥å¿—**ï¼šæ¯ä¸ªæ­¥éª¤éƒ½æœ‰structlogè®°å½•
âœ… **å¯æµ‹è¯•æ€§**ï¼šçº¯å‡½æ•°è®¾è®¡ï¼Œæ˜“äºå•å…ƒæµ‹è¯•

ç³»ç»Ÿå·²ç»å¯ä»¥æŠ•å…¥ä½¿ç”¨ï¼Œåªéœ€æ‰§è¡Œä¸Šè¿°æ­¥éª¤å®Œæˆæ•°æ®åº“è¿ç§»å’Œé…ç½®å³å¯ã€‚
